import{a as he,b as U,Q as R}from"./QItem.fa8636d8.js";import{Q as ae}from"./QBadge.c38431b1.js";import{x as fe,aN as it,aO as rt,l as L,j as B,C as X,h as te,av as je,ax as Ye,aw as Xe,E as ne,G as h,H as F,L as w,M as b,O as M,t as r,aP as lt,I as c,K as E,S as v,V as S,aQ as ct,aR as ut,aB as Be,F as pe,ay as ve,Y as dt,Q as A,A as Fe,f as mt,a as ge,r as I,aG as Je,aC as De,aA as ue,ar as Ge,W as Ne,X as _e}from"./index.7a0464ee.js";import{a as ht}from"./welcome.a6301428.js";import{a as ft}from"./QSelect.4463676a.js";import{g as Ue,Q as de}from"./QInput.62cb7953.js";import{a as V,M as We,g as be,E as H,r as pt,p,v as P,w as j,f as O,j as Oe,A as x,x as Te,c as Ze,F as me,N as ke,G as Ve,H as Se,I as xe,J as Le,K as ze,L as Ke,O as vt,Q as gt,R as yt,T as bt}from"./ui.64f31f6c.js";import{i as wt}from"./i18n.e67af30b.js";import{u as kt,a as St,b as Pt,Q as z}from"./QSpinnerDots.49327f1a.js";import{Q as et,a as tt}from"./QDialog.33afde77.js";import{C as Ft}from"./QSpinnerHourglass.d80217d7.js";import{i as Dt}from"./vue-qrcode.esm.95cc9ae1.js";import{Q as Nt}from"./QCheckbox.b4dcaa72.js";import{Q as $e}from"./QList.e5a0038a.js";import{a as _t,c as Tt}from"./use-timeout.7d10f4b4.js";import{u as q}from"./index.81b98c8b.js";var $t=fe({name:"QCardActions",props:{...it,vertical:Boolean},setup(e,{slots:t}){const n=rt(e),o=L(()=>`q-card__actions ${n.value} q-card__actions--${e.vertical===!0?"vert column":"horiz row"}`);return()=>B("div",{class:o.value},X(t.default))}}),Pe=fe({name:"QCardSection",props:{tag:{type:String,default:"div"},horizontal:Boolean},setup(e,{slots:t}){const n=L(()=>`q-card__section q-card__section--${e.horizontal===!0?"horiz row no-wrap":"vert"}`);return()=>B(e.tag,{class:n.value},X(t.default))}});function T(e){const t=Object.prototype.toString.call(e);return e instanceof Date||typeof e=="object"&&t==="[object Date]"?new e.constructor(+e):typeof e=="number"||t==="[object Number]"||typeof e=="string"||t==="[object String]"?new Date(e):new Date(NaN)}function Mt(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}const Wo=6e4,Oo=36e5,ie=43200,Qe=1440;let Ct={};function qt(){return Ct}function He(e){const t=T(e),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return n.setUTCFullYear(t.getFullYear()),+e-+n}function ce(e,t){const n=T(e),o=T(t),s=n.getTime()-o.getTime();return s<0?-1:s>0?1:s}function Et(e){return Mt(e,Date.now())}function At(e,t){const n=T(e),o=T(t),s=n.getFullYear()-o.getFullYear(),i=n.getMonth()-o.getMonth();return s*12+i}function Rt(e){return t=>{const o=(e?Math[e]:Math.trunc)(t);return o===0?0:o}}function It(e,t){return+T(e)-+T(t)}function Bt(e){const t=T(e);return t.setHours(23,59,59,999),t}function Ut(e){const t=T(e),n=t.getMonth();return t.setFullYear(t.getFullYear(),n+1,0),t.setHours(23,59,59,999),t}function Wt(e){const t=T(e);return+Bt(t)==+Ut(t)}function Ot(e,t){const n=T(e),o=T(t),s=ce(n,o),i=Math.abs(At(n,o));let a;if(i<1)a=0;else{n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-s*i);let l=ce(n,o)===-s;Wt(T(e))&&i===1&&ce(e,o)===1&&(l=!1),a=s*(i-Number(l))}return a===0?0:a}function Vt(e,t,n){const o=It(e,t)/1e3;return Rt(n?.roundingMethod)(o)}const xt={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Lt=(e,t,n)=>{let o;const s=xt[e];return typeof s=="string"?o=s:t===1?o=s.one:o=s.other.replace("{{count}}",t.toString()),n?.addSuffix?n.comparison&&n.comparison>0?"in "+o:o+" ago":o};function we(e){return(t={})=>{const n=t.width?String(t.width):e.defaultWidth;return e.formats[n]||e.formats[e.defaultWidth]}}const zt={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Kt={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Qt={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Ht={date:we({formats:zt,defaultWidth:"full"}),time:we({formats:Kt,defaultWidth:"full"}),dateTime:we({formats:Qt,defaultWidth:"full"})},jt={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Yt=(e,t,n,o)=>jt[e];function Z(e){return(t,n)=>{const o=n?.context?String(n.context):"standalone";let s;if(o==="formatting"&&e.formattingValues){const a=e.defaultFormattingWidth||e.defaultWidth,l=n?.width?String(n.width):a;s=e.formattingValues[l]||e.formattingValues[a]}else{const a=e.defaultWidth,l=n?.width?String(n.width):e.defaultWidth;s=e.values[l]||e.values[a]}const i=e.argumentCallback?e.argumentCallback(t):t;return s[i]}}const Xt={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Jt={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Gt={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Zt={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},en={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},tn={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},nn=(e,t)=>{const n=Number(e),o=n%100;if(o>20||o<10)switch(o%10){case 1:return n+"st";case 2:return n+"nd";case 3:return n+"rd"}return n+"th"},on={ordinalNumber:nn,era:Z({values:Xt,defaultWidth:"wide"}),quarter:Z({values:Jt,defaultWidth:"wide",argumentCallback:e=>e-1}),month:Z({values:Gt,defaultWidth:"wide"}),day:Z({values:Zt,defaultWidth:"wide"}),dayPeriod:Z({values:en,defaultWidth:"wide",formattingValues:tn,defaultFormattingWidth:"wide"})};function ee(e){return(t,n={})=>{const o=n.width,s=o&&e.matchPatterns[o]||e.matchPatterns[e.defaultMatchWidth],i=t.match(s);if(!i)return null;const a=i[0],l=o&&e.parsePatterns[o]||e.parsePatterns[e.defaultParseWidth],u=Array.isArray(l)?an(l,y=>y.test(a)):sn(l,y=>y.test(a));let d;d=e.valueCallback?e.valueCallback(u):u,d=n.valueCallback?n.valueCallback(d):d;const f=t.slice(a.length);return{value:d,rest:f}}}function sn(e,t){for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&t(e[n]))return n}function an(e,t){for(let n=0;n<e.length;n++)if(t(e[n]))return n}function rn(e){return(t,n={})=>{const o=t.match(e.matchPattern);if(!o)return null;const s=o[0],i=t.match(e.parsePattern);if(!i)return null;let a=e.valueCallback?e.valueCallback(i[0]):i[0];a=n.valueCallback?n.valueCallback(a):a;const l=t.slice(s.length);return{value:a,rest:l}}}const ln=/^(\d+)(th|st|nd|rd)?/i,cn=/\d+/i,un={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},dn={any:[/^b/i,/^(a|c)/i]},mn={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},hn={any:[/1/i,/2/i,/3/i,/4/i]},fn={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},pn={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},vn={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},gn={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},yn={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},bn={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},wn={ordinalNumber:rn({matchPattern:ln,parsePattern:cn,valueCallback:e=>parseInt(e,10)}),era:ee({matchPatterns:un,defaultMatchWidth:"wide",parsePatterns:dn,defaultParseWidth:"any"}),quarter:ee({matchPatterns:mn,defaultMatchWidth:"wide",parsePatterns:hn,defaultParseWidth:"any",valueCallback:e=>e+1}),month:ee({matchPatterns:fn,defaultMatchWidth:"wide",parsePatterns:pn,defaultParseWidth:"any"}),day:ee({matchPatterns:vn,defaultMatchWidth:"wide",parsePatterns:gn,defaultParseWidth:"any"}),dayPeriod:ee({matchPatterns:yn,defaultMatchWidth:"any",parsePatterns:bn,defaultParseWidth:"any"})},kn={code:"en-US",formatDistance:Lt,formatLong:Ht,formatRelative:Yt,localize:on,match:wn,options:{weekStartsOn:0,firstWeekContainsDate:1}};function Sn(e,t,n){const o=qt(),s=n?.locale??o.locale??kn,i=2520,a=ce(e,t);if(isNaN(a))throw new RangeError("Invalid time value");const l=Object.assign({},n,{addSuffix:n?.addSuffix,comparison:a});let u,d;a>0?(u=T(t),d=T(e)):(u=T(e),d=T(t));const f=Vt(d,u),y=(He(d)-He(u))/1e3,g=Math.round((f-y)/60);let $;if(g<2)return n?.includeSeconds?f<5?s.formatDistance("lessThanXSeconds",5,l):f<10?s.formatDistance("lessThanXSeconds",10,l):f<20?s.formatDistance("lessThanXSeconds",20,l):f<40?s.formatDistance("halfAMinute",0,l):f<60?s.formatDistance("lessThanXMinutes",1,l):s.formatDistance("xMinutes",1,l):g===0?s.formatDistance("lessThanXMinutes",1,l):s.formatDistance("xMinutes",g,l);if(g<45)return s.formatDistance("xMinutes",g,l);if(g<90)return s.formatDistance("aboutXHours",1,l);if(g<Qe){const D=Math.round(g/60);return s.formatDistance("aboutXHours",D,l)}else{if(g<i)return s.formatDistance("xDays",1,l);if(g<ie){const D=Math.round(g/Qe);return s.formatDistance("xDays",D,l)}else if(g<ie*2)return $=Math.round(g/ie),s.formatDistance("aboutXMonths",$,l)}if($=Ot(d,u),$<12){const D=Math.round(g/ie);return s.formatDistance("xMonths",D,l)}else{const D=$%12,K=Math.trunc($/12);return D<3?s.formatDistance("aboutXYears",K,l):D<9?s.formatDistance("overXYears",K,l):s.formatDistance("almostXYears",K+1,l)}}function Pn(e,t){return Sn(e,Et(e),t)}var Fn=fe({name:"QResponsive",props:kt,setup(e,{slots:t}){const n=St(e);return()=>B("div",{class:"q-responsive"},[B("div",{class:"q-responsive__filler overflow-hidden"},[B("div",{style:n.value})]),B("div",{class:"q-responsive__content absolute-full fit"},X(t.default))])}});const Dn=te({name:"ChooseMint",mixins:[windowMixin],props:{rounded:{type:Boolean,default:!1},dense:{type:Boolean,default:!1},title:{type:String,default:wt.global.t("ChooseMint.title")},style:{type:String,default:""},placeholder:{type:String,default:""},showBalances:{type:Boolean,default:!0},requireActiveMint:{type:Boolean,default:!0},modelValue:{type:String,default:null}},emits:["update:modelValue"],data:function(){return{chosenMint:null}},mounted(){this.initializeChosenMint()},watch:{chosenMint:async function(){this.modelValue!==null?this.$emit("update:modelValue",this.chosenMint?.url||""):this.activeMintUrl=this.chosenMint?.url||""},modelValue:{handler(){this.initializeChosenMint()},immediate:!0},activeMintUrl:{handler(){this.modelValue===null&&this.initializeChosenMint()}}},computed:{...je(V,["activeMintUrl","activeProofs","mints","activeUnit"]),...Ye(V,["activeMintUrl"]),getBalance:function(){return this.activeProofs.flat().reduce((e,t)=>e+=t.amount,0)}},methods:{...Xe(V,["activateMintUrl"]),initializeChosenMint(){const e=this.modelValue!==null?this.modelValue:this.activeMintUrl;if(e){const t=this.mints.find(n=>n.url===e);if(t){const n=new We(t);this.chosenMint={url:e,nickname:n.mint.nickname||n.mint.info?.name,shorturl:Ue(e),errored:n.mint.errored}}}},chooseMintOptions:function(){let e=[];for(const[t,n]of Object.entries(this.mints)){const o=n.keysets.map(a=>a.unit),s=[...new Set(o)],i=new We(n);e.push({nickname:i.mint.nickname||i.mint.info?.name,url:i.mint.url,shorturl:Ue(n.url),balances:i.allBalances,errored:i.mint.errored,units:s})}return e}}}),Nn={class:"q-pb-md"},_n={key:0,class:"row q-mb-none"},Tn={class:"col-12"},$n={class:"text-caption"},Mn={key:1,class:"row q-mt-xs q-mb-none"},Cn={class:"col-12 cursor-pointer"},qn={key:0},En={key:0,class:"error-badge"},An={class:"row items-center"};function Rn(e,t,n,o,s,i){return h(),F("div",Nn,[e.title.length?(h(),F("div",_n,[w("div",Tn,[w("span",$n,b(e.title),1)])])):M("",!0),e.activeMintUrl||!e.requireActiveMint?(h(),F("div",Mn,[w("div",Cn,[r(ft,{outlined:"",class:"q-px-none",color:"white",modelValue:e.chosenMint,"onUpdate:modelValue":t[0]||(t[0]=a=>e.chosenMint=a),options:e.chooseMintOptions(),"option-value":"url","option-label":"nickname",rounded:e.rounded,style:Be(e.style),dense:e.dense,placeholder:e.placeholder},lt({option:c(a=>[r(he,ct(ut(a.itemProps)),{default:c(()=>[r(U,null,{default:c(()=>[r(R,{class:"text-body1 q-pt-xs",style:Be(e.activeMintUrl===a.opt.url?"font-weight: bold":"")},{default:c(()=>[v(b(a.opt.nickname||a.opt.shorturl),1)]),_:2},1032,["style"]),r(R,{class:"text-caption q-pb-xs",style:{"font-family":"monospace","font-size":"11px"}},{default:c(()=>[v(b(a.opt.url),1)]),_:2},1024),e.showBalances?(h(),F("div",qn,[(h(!0),F(pe,null,ve(a.opt.units,l=>(h(),E(ae,{key:l,color:a.opt.url===e.activeMintUrl?"primary":"grey",label:e.formatCurrency(a.opt.balances[l],l),class:"q-mr-xs q-mb-xs"},null,8,["color","label"]))),128)),a.opt.errored?(h(),F("div",En,[r(ae,{color:"red",class:"q-mr-xs q-mt-sm text-weight-bold"},{default:c(()=>[v(b(e.$t("ChooseMint.badge_option_mint_error_text"))+" ",1),r(S,{name:"error",class:"q-ml-xs"})]),_:1})])):M("",!0)])):M("",!0)]),_:2},1024)]),_:2},1040),r(ht)]),prepend:c(()=>[r(S,{name:"account_balance",size:"1.2rem",color:"grey",class:"q-mr-none q-mb-none"})]),_:2},[e.showBalances?{name:"append",fn:c(()=>[w("div",An,[e.chosenMint?.errored?(h(),E(ae,{key:0,color:"red",class:"q-mr-xs text-weight-bold"},{default:c(()=>[v(b(e.$t("ChooseMint.badge_mint_error_text"))+" ",1),r(S,{name:"error",class:"q-ml-xs"})]),_:1})):M("",!0),r(ae,{color:"primary",label:e.formatCurrency(e.getBalance,e.activeUnit),class:"q-ma-xs q-pa-sm text-weight-bold"},null,8,["label"])])]),key:"0"}:void 0]),1032,["modelValue","options","rounded","style","dense","placeholder"])])])):M("",!0)])}var Vo=ne(Dn,[["render",Rn]]);const In=te({name:"P2PKDialog",mixins:[windowMixin],components:{VueQrcode:Dt},data:function(){return{}},computed:{...je(be,["p2pkKeys","showP2PKData","showLastKey"]),...Ye(be,["showP2PKDialog"])},methods:{...Xe(be,["generateKeypair","showKeyDetails"]),newKeys:function(){this.generateKeypair(),this.showLastKey()}}}),Bn={class:"text-center q-mb-md q-mt-none q-pt-none"},Un={class:"row justify-center"},Wn={class:"row justify-center"},On={key:0,class:"row justify-center q-pt-sm"},Vn={key:1,class:"row justify-center q-pt-sm"},xn={class:"row q-mt-lg"};function Ln(e,t,n,o,s,i){const a=dt("vue-qrcode");return h(),E(tt,{modelValue:e.showP2PKDialog,"onUpdate:modelValue":t[1]||(t[1]=l=>e.showP2PKDialog=l),position:"top","backdrop-filter":"blur(2px) brightness(60%)"},{default:c(()=>[e.showP2PKData.publicKey?(h(),E(et,{key:0,class:"q-px-lg q-pt-md q-pb-md qcard"},{default:c(()=>[w("div",Bn,[r(Fn,{ratio:1,class:"q-mx-md q-mt-none q-pt-none"},{default:c(()=>[r(a,{value:e.showP2PKData.publicKey,options:{width:340},class:"rounded-borders"},null,8,["value"])]),_:1}),w("div",Un,[r(Pe,{class:"q-pa-sm"},{default:c(()=>[w("div",Wn,[r(R,{overline:"",class:"q-mb-sm q-pt-md text-white"},{default:c(()=>[v(b(e.$t("P2PKDialog.p2pk.caption")),1)]),_:1})]),e.showP2PKData.used?(h(),F("div",On,[r(R,{caption:"",class:"text-weight-bold text-warning",style:{"font-size":"14px"}},{default:c(()=>[v(b(e.$t("P2PKDialog.p2pk.used_warning_text")),1)]),_:1})])):(h(),F("div",Vn,[r(R,{caption:"",class:"text-weight-light text-white",style:{"font-size":"14px"}},{default:c(()=>[v(b(e.$t("P2PKDialog.p2pk.description")),1)]),_:1})]))]),_:1})]),r(A,{class:"q-mx-xs q-px-md q-mt-md",size:"md",color:"primary",flat:"",rounded:"",dense:"",onClick:e.newKeys},{default:c(()=>[r(S,{name:"refresh",class:"q-pr-sm",size:"xs"}),v(" "+b(e.$t("P2PKDialog.actions.new_key.label")),1)]),_:1},8,["onClick"]),w("div",xn,[r(A,{class:"q-mx-xs",size:"md",flat:"",onClick:t[0]||(t[0]=l=>e.copyText(e.showP2PKData.publicKey))},{default:c(()=>[v(b(e.$t("P2PKDialog.actions.copy.label")),1)]),_:1}),Fe((h(),E(A,{flat:"",color:"grey",class:"q-ml-auto"},{default:c(()=>[v(b(e.$t("P2PKDialog.actions.close.label")),1)]),_:1})),[[Ft]])])])]),_:1})):M("",!0)]),_:1},8,["modelValue"])}var xo=ne(In,[["render",Ln]]),nt=fe({name:"QBanner",props:{..._t,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(e,{slots:t}){const{proxy:{$q:n}}=mt(),o=Tt(e,n),s=L(()=>"q-banner row items-center"+(e.dense===!0?" q-banner--dense":"")+(o.value===!0?" q-banner--dark q-dark":"")+(e.rounded===!0?" rounded-borders":"")),i=L(()=>`q-banner__actions row items-center justify-end col-${e.inlineActions===!0?"auto":"all"}`);return()=>{const a=[B("div",{class:"q-banner__avatar col-auto row items-center self-start"},X(t.avatar)),B("div",{class:"q-banner__content col text-body2"},X(t.default))],l=X(t.action);return l!==void 0&&a.push(B("div",{class:i.value},l)),B("div",{class:s.value+(e.inlineActions===!1&&l!==void 0?" q-banner--top-padding":""),role:"alert"},a)}}});console.log("\u{1F535} [BluetoothEcash] Registering plugin, platform:",H.getPlatform());const k=pt("BluetoothEcash",{web:()=>({startService:async()=>{console.warn("Bluetooth mesh not available in web browser")},stopService:async()=>{},setNickname:async()=>({nickname:""}),getNickname:async()=>({nickname:""}),isBluetoothEnabled:async()=>({enabled:!1}),requestBluetoothEnable:async()=>({requested:!1}),sendToken:async()=>({messageId:""}),sendTextMessage:async()=>{},getAvailablePeers:async()=>({peers:[]}),getUnclaimedTokens:async()=>({tokens:[]}),markTokenClaimed:async()=>{},requestPermissions:async()=>({granted:!1}),addListener:async()=>({remove:()=>{}})})});console.log("\u{1F535} [BluetoothEcash] Plugin registered successfully");const re="f47b5e2d-4a9e-4c5a-9b3f-8e1d2c3a4b5c",zn="a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d";class ot{devices=new Map;myNickname="Bitpoints User";isScanning=!1;onTokenReceived;onPeerDiscovered;static isAvailable(){return typeof navigator<"u"&&"bluetooth"in navigator}initialize(t){this.myNickname=t}async requestDevice(){try{if(console.log("\u{1F50D} Starting Web Bluetooth device discovery..."),console.log("\u{1F4CD} Current URL:",window.location.href),console.log("\u{1F512} HTTPS:",window.location.protocol==="https:"),!navigator.bluetooth)throw new Error("Web Bluetooth not supported in this browser");let t;try{console.log("\u{1F3AF} Attempting to find devices with Bitpoints service..."),t=await navigator.bluetooth.requestDevice({filters:[{services:[re]}],optionalServices:[re]}),console.log("\u2705 Found device with Bitpoints service:",t.name)}catch(s){console.log("\u26A0\uFE0F No devices with Bitpoints service found, trying generic BLE devices..."),console.log("Service error:",s),console.log("\u{1F50D} Requesting all BLE devices..."),t=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[re]}),console.log("\u2705 Found generic BLE device:",t.name)}let n=t.name||"Unknown Device";t.name&&t.name.startsWith("BP:")?n=t.name.substring(3):t.name&&(n=t.name);const o={id:t.id,nickname:n,device:t,lastSeen:Date.now()};this.devices.set(t.id,o);try{await this.connectToPeer(o)}catch(s){console.warn("Could not connect to device with Bitpoints service, but device is available:",s)}return this.onPeerDiscovered&&this.onPeerDiscovered(o),o}catch(t){return console.error("Failed to request Bluetooth device:",t),(t.name==="NotFoundError"||t.name==="SecurityError")&&console.log("User cancelled device selection or permission denied"),null}}async connectToPeer(t){try{if(!t.device.gatt){console.error("Device has no GATT server");return}const n=await t.device.gatt.connect();t.server=n;const s=await(await n.getPrimaryService(re)).getCharacteristic(zn);t.characteristic=s,s.addEventListener("characteristicvaluechanged",i=>{const l=i.target.value;l&&this.handleReceivedData(l,t)}),await s.startNotifications(),console.log(`Connected to peer: ${t.nickname} (${t.id})`)}catch(n){console.error("Failed to connect to peer:",n)}}async sendToken(t,n){const o=this.devices.get(n);if(!o||!o.characteristic)return console.error("Peer not connected:",n),!1;try{const s={type:"ECASH_TOKEN",token:t,sender:this.myNickname,timestamp:Date.now()},i=new TextEncoder().encode(JSON.stringify(s));return await o.characteristic.writeValue(i),console.log(`Sent token to ${o.nickname} via Web Bluetooth`),!0}catch(s){return console.error("Failed to send token:",s),!1}}handleReceivedData(t,n){try{const s=new TextDecoder().decode(t),i=JSON.parse(s);i.type==="ECASH_TOKEN"&&i.token&&(console.log(`Received token from ${n.nickname} via Web Bluetooth`),this.onTokenReceived&&this.onTokenReceived(i.token,n))}catch(o){console.error("Failed to parse received data:",o)}}getPeers(){return Array.from(this.devices.values())}async disconnect(t){const n=this.devices.get(t);n&&n.server&&(n.server.disconnect(),this.devices.delete(t))}disconnectAll(){for(const t of this.devices.values())t.server&&t.server.disconnect();this.devices.clear()}setOnTokenReceived(t){this.onTokenReceived=t}setOnPeerDiscovered(t){this.onPeerDiscovered=t}}const Q=new ot,J=ge("favorites",{state:()=>({favorites:q("bitpoints-favorites",{}),pendingRequests:q("bitpoints-pending-favorites",{})}),getters:{mutualFavorites:e=>Object.values(e.favorites).filter(t=>t.isFavorite&&t.theyFavoritedUs),myFavorites:e=>Object.values(e.favorites).filter(t=>t.isFavorite),favoritesWithNostr:e=>Object.values(e.favorites).filter(t=>t.isFavorite&&t.peerNostrNpub!==null),mutualCount(){return this.mutualFavorites.length},pendingRequestsList:e=>Object.values(e.pendingRequests),pendingCount(){return this.pendingRequestsList.length}},actions:{addFavorite(e,t,n=null){console.log(`\u2B50\uFE0F Adding favorite: ${t} (${e.substring(0,16)}...)`);const o=this.favorites[e],s={peerNoisePublicKey:e,peerNostrNpub:n??o?.peerNostrNpub??null,peerNickname:t,isFavorite:!0,theyFavoritedUs:o?.theyFavoritedUs??!1,favoritedAt:o?.favoritedAt??new Date,lastUpdated:new Date};s.isFavorite&&s.theyFavoritedUs&&console.log(`\u{1F495} Mutual favorite relationship established with ${t}!`),this.favorites[e]=s},removeFavorite(e){const t=this.favorites[e];!t||(console.log(`\u2B50\uFE0F Removing favorite: ${t.peerNickname}`),t.theyFavoritedUs?this.favorites[e]={...t,isFavorite:!1,lastUpdated:new Date}:delete this.favorites[e])},updatePeerFavoritedUs(e,t,n,o){const s=this.favorites[e],i=n??s?.peerNickname??"Unknown";console.log(`\u{1F4E8} Received favorite notification: ${i} ${t?"favorited":"unfavorited"} us`);const a={peerNoisePublicKey:e,peerNostrNpub:o??s?.peerNostrNpub??null,peerNickname:i,isFavorite:s?.isFavorite??!1,theyFavoritedUs:t,favoritedAt:s?.favoritedAt??new Date,lastUpdated:new Date};!a.isFavorite&&!a.theyFavoritedUs?delete this.favorites[e]:(this.favorites[e]=a,a.isFavorite&&a.theyFavoritedUs&&console.log(`\u{1F495} Mutual favorite relationship established with ${i}!`))},isFavorite(e){return this.favorites[e]?.isFavorite??!1},isMutualFavorite(e){const t=this.favorites[e];return(t?.isFavorite&&t?.theyFavoritedUs)??!1},getFavoriteStatus(e){return this.favorites[e]??null},updateNostrNpub(e,t){const n=this.favorites[e];n&&(this.favorites[e]={...n,peerNostrNpub:t,lastUpdated:new Date},console.log(`Updated Nostr npub for ${n.peerNickname}`))},clearAll(){console.log("\u{1F9F9} Clearing all favorites"),this.favorites={}},addPendingRequest(e,t,n){console.log(`\u{1F4EC} [STORE] Adding pending request: ${t} (${e.substring(0,16)}...)`),console.log(`\u{1F4EC} [STORE] npub: ${n.substring(0,16)}...`);const o={peerNoisePublicKey:e,peerNickname:t,peerNostrNpub:n,receivedAt:new Date};this.pendingRequests[e]=o,console.log("\u{1F4EC} [STORE] Pending request saved. Total count:",Object.keys(this.pendingRequests).length),console.log("\u{1F4EC} [STORE] Pending requests:",this.pendingRequests)},removePendingRequest(e){console.log(`\u{1F5D1}\uFE0F Removing pending request from: ${e.substring(0,16)}...`),delete this.pendingRequests[e]},acceptPendingRequest(e){const t=this.pendingRequests[e];return t?(console.log(`\u2705 Accepting favorite request from: ${t.peerNickname}`),this.addFavorite(t.peerNoisePublicKey,t.peerNickname,t.peerNostrNpub),this.updatePeerFavoritedUs(t.peerNoisePublicKey,!0),this.removePendingRequest(e),t):(console.warn(`\u26A0\uFE0F No pending request found for ${e}`),null)}}}),st=ge("bluetooth",{state:()=>({isActive:!1,isInitialized:!1,nearbyPeers:[],unclaimedTokens:q("bluetooth-unclaimed-tokens",[]),contacts:q("bluetooth-contacts",[]),pendingMessages:[],nickname:q("bluetooth-nickname","Bitpoints User"),alwaysOnEnabled:q("bluetooth-always-on",!0),alwaysOnActive:!1}),getters:{isDesktop:()=>!H.isNativePlatform(),isWebBluetoothAvailable:()=>{try{return ot.isAvailable()}catch(e){return console.error("Error checking Web Bluetooth availability:",e),!1}},isBluetoothAvailable(){return H.isNativePlatform()||this.isWebBluetoothAvailable},sortedPeers:e=>[...e.nearbyPeers].sort((t,n)=>n.lastSeen-t.lastSeen),directPeers:e=>e.nearbyPeers.filter(t=>t.isDirect),knownPeers:e=>e.nearbyPeers.filter(t=>t.nostrNpub&&t.nostrNpub.length>0),unclaimedCount:e=>e.unclaimedTokens.filter(t=>!t.claimed).length,unclaimedValue:e=>e.unclaimedTokens.filter(t=>!t.claimed&&t.unit==="sat").reduce((t,n)=>t+n.amount,0)},actions:{async initialize(){if(!this.isInitialized)try{if(this.isDesktop){if(!this.isWebBluetoothAvailable){console.log("Web Bluetooth not available. Use Chrome or Edge browser.");return}Q.initialize(this.nickname),Q.setOnPeerDiscovered(e=>{console.log("Web Bluetooth: Peer discovered",e),this.handlePeerDiscovered({peerID:e.id,nickname:e.nickname,lastSeen:e.lastSeen,isDirect:!0,nostrNpub:"",isConnected:!0})}),Q.setOnTokenReceived((e,t)=>{console.log("Web Bluetooth: Token received",e),this.handleEcashReceived({id:Date.now().toString(),sender:t.nickname,senderPeerID:t.id,timestamp:Date.now(),amount:0,unit:"sat",cashuToken:e,mint:"",memo:"",claimed:!1,deliveryStatus:"delivered"})}),this.isInitialized=!0,console.log("Web Bluetooth service initialized");return}await k.addListener("ecashReceived",e=>{console.log("Ecash received via Bluetooth:",e),this.handleEcashReceived(e)}),await k.addListener("peerDiscovered",e=>{console.log("Peer discovered:",e),this.handlePeerDiscovered(e)}),await k.addListener("peerLost",e=>{console.log("Peer lost:",e),this.handlePeerLost(e.peerID)}),await k.addListener("tokenSent",e=>{console.log("Token sent:",e),this.handleTokenSent(e.messageId)}),await k.addListener("tokenDelivered",e=>{console.log("Token delivered:",e),this.handleTokenDelivered(e.messageId,e.peerID)}),await k.addListener("favoriteNotificationReceived",e=>{console.log("\u2B50\uFE0F Favorite notification received:",e),this.handleFavoriteNotification(e.peerID,e.npub,e.isFavorite)}),await k.addListener("favoriteRequestReceived",e=>{console.log("\u{1F4EC} [LISTENER] Favorite request received:",e),console.log("\u{1F4EC} [LISTENER] peerID:",e.peerID),console.log("\u{1F4EC} [LISTENER] nickname:",e.nickname),console.log("\u{1F4EC} [LISTENER] npub:",e.npub?.substring(0,16)),this.handleFavoriteRequest(e.peerID,e.nickname,e.npub)}),await k.addListener("favoriteAcceptedReceived",e=>{console.log("\u2705 Favorite accepted received:",e),this.handleFavoriteAccepted(e.peerID,e.npub)}),this.isInitialized=!0,console.log("Bluetooth ecash service initialized"),this.debugTokenState(),this.unclaimedTokens.length>50?(console.log(`\u{1F9F9} Too many tokens (${this.unclaimedTokens.length}), clearing localStorage`),this.clearAllUnclaimedTokens()):this.cleanupUnclaimedTokensOnStartup().catch(console.error)}catch(e){console.error("Failed to initialize Bluetooth service:",e)}},async startService(){try{if(this.isDesktop){if(console.log("\u{1F5A5}\uFE0F Desktop PWA detected, using Web Bluetooth..."),!this.isWebBluetoothAvailable)return console.error("\u274C Web Bluetooth not available"),p("Web Bluetooth not supported. Please use Chrome or Edge browser."),!1;console.log("\u2705 Web Bluetooth available, starting service..."),console.log("\u{1F517} Current URL:",window.location.href),console.log("\u{1F512} HTTPS enabled:",window.location.protocol==="https:"),console.log("\u{1F3AF} Requesting Bluetooth device...");const t=await Q.requestDevice();return t?(console.log("\u{1F389} Device connected successfully:",t),this.isActive=!0,P(`Connected to ${t.nickname}!`),console.log("\u2705 Web Bluetooth service started"),!0):(console.log("\u26A0\uFE0F User cancelled device selection or no device available"),!1)}const{granted:e}=await k.requestPermissions();return e?(console.log(`Setting Bluetooth nickname: ${this.nickname}`),await k.setNickname({nickname:this.nickname}),await k.startService(),this.isActive=!0,console.log(`Bluetooth mesh service started with nickname: ${this.nickname}`),this.startPeerPolling(),!0):(j("Bluetooth permissions required for nearby payments"),!1)}catch(e){return console.error("Failed to start Bluetooth service:",e),p("Failed to start Bluetooth service"),!1}},async stopService(){try{if(this.isDesktop){Q.disconnectAll(),this.isActive=!1,this.nearbyPeers=[],console.log("Web Bluetooth service stopped");return}await k.stopService(),this.isActive=!1,this.nearbyPeers=[],console.log("Bluetooth mesh service stopped")}catch(e){console.error("Failed to stop Bluetooth service:",e)}},async updateNickname(e){if(e.length<3||e.length>32)throw new Error("Nickname must be 3-32 characters");const t=this.isActive;this.nickname=e,this.isDesktop?Q.initialize(e):await k.setNickname({nickname:e}),t&&(await this.stopService(),await this.startService(),console.log(`Bluetooth nickname updated to: ${e}`))},async sendToken(e){console.log("\u{1F535} [STORE] sendToken called with:",e);try{if(this.isDesktop){if(!e.peerID)return p("Web Bluetooth requires specific peer selection"),null;if(console.log("\u{1F535} [WEB] Sending token via Web Bluetooth..."),await Q.sendToken(e.token,e.peerID)){const s=Date.now().toString();return this.pendingMessages.push(s),console.log("\u{1F535} [WEB] Success, messageId:",s),s}else return p("Failed to send token via Web Bluetooth"),null}console.log("\u{1F535} [STORE] Calling BluetoothEcash.sendToken...");const t=await k.sendToken(e);console.log("\u{1F535} [STORE] Native returned:",t);const{messageId:n}=t;return this.pendingMessages.push(n),console.log("\u{1F535} [STORE] Success, returning messageId:",n),n}catch(t){return console.error("\u{1F535} [STORE ERROR]:",t),p("Failed to send token via Bluetooth"),null}},async sendTextMessage(e,t){try{return this.isActive?this.isDesktop?(console.warn("Web Bluetooth text messaging not supported yet"),!1):(await k.sendTextMessage({peerID:e,message:t}),console.log(`\u{1F4E4} Sent text message to ${e}: ${t.substring(0,30)}...`),!0):(console.warn("Bluetooth not active, cannot send text message"),!1)}catch(n){return console.error("Failed to send text message:",n),!1}},async claimToken(e){try{const t=this.unclaimedTokens.find(i=>i.id===e);if(!t)throw new Error("Token not found");const n=O(),o=Oe();if(o.receiveData.tokensBase64=t.cashuToken,await o.receiveIfDecodes()){await k.markTokenClaimed({messageId:e});const i=this.unclaimedTokens.findIndex(a=>a.id===e);return i!==-1&&(this.unclaimedTokens[i]={...t,claimed:!0}),this.addContact(t.sender,t.senderPeerID),P(`Claimed ${t.amount} ${t.unit} from ${t.sender.substring(0,16)}...`),!0}else throw new Error("Failed to redeem token with mint")}catch(t){console.error("Failed to claim token:",t);const n=t?.message||t?.toString()||"";if(n.includes("Token already spent")||n.includes("already spent")){console.log(`Token ${e} already spent, removing from unclaimed list`);const o=this.unclaimedTokens.findIndex(s=>s.id===e);return o!==-1&&(this.unclaimedTokens.splice(o,1),console.log(`Removed already spent token ${e} from unclaimed list`)),!0}return p("Failed to claim token"),!1}},async autoClaimTokens(){if(!navigator.onLine){console.log("Offline - skipping auto-claim");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);console.log(`Auto-claiming ${e.length} tokens`);for(const t of e)await this.claimToken(t.id),await new Promise(n=>setTimeout(n,500))},async autoClaimTokensSilently(){if(console.log("\u{1F527} Starting autoClaimTokensSilently..."),!navigator.onLine){console.log("Offline - skipping silent auto-claim");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);console.log(`Silently claiming ${e.length} tokens`);for(const t of e){try{await this.claimTokenSilently(t.id)}catch(n){console.log(`Failed to claim token ${t.id}:`,n)}await new Promise(n=>setTimeout(n,200))}console.log(`Silent claim completed. Remaining unclaimed tokens: ${this.unclaimedTokens.filter(t=>!t.claimed).length}`)},async cleanupUnclaimedTokensOnStartup(){if(console.log("\u{1F527} Starting cleanupUnclaimedTokensOnStartup..."),!navigator.onLine){console.log("Offline - skipping startup cleanup");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);if(console.log(`Found ${e.length} unclaimed tokens`),e.length===0){console.log("No unclaimed tokens to clean up");return}console.log(`Cleaning up ${e.length} unclaimed tokens on startup...`);for(const t of e){try{await this.claimTokenSilently(t.id)&&console.log(`Successfully claimed token ${t.id}`)}catch(n){console.log(`Failed to claim token ${t.id}:`,n)}await new Promise(n=>setTimeout(n,200))}console.log(`Startup cleanup completed. Remaining unclaimed tokens: ${this.unclaimedTokens.filter(t=>!t.claimed).length}`)},clearAllUnclaimedTokens(){const e=this.unclaimedTokens.length;this.unclaimedTokens=[],localStorage.removeItem("bluetooth-unclaimed-tokens"),console.log(`\u{1F9F9} Force cleared ${e} unclaimed tokens from memory and localStorage`),P(`Cleared ${e} unclaimed tokens`)},debugTokenState(){console.log(`\u{1F50D} Debug: Total unclaimed tokens: ${this.unclaimedTokens.length}`),console.log(`\u{1F50D} Debug: Claimed tokens: ${this.unclaimedTokens.filter(e=>e.claimed).length}`),console.log(`\u{1F50D} Debug: Unclaimed tokens: ${this.unclaimedTokens.filter(e=>!e.claimed).length}`),this.unclaimedTokens.forEach((e,t)=>{console.log(`\u{1F50D} Token ${t}: ID=${e.id}, Amount=${e.amount}, Claimed=${e.claimed}`)})},async claimTokenSilently(e){try{const t=this.unclaimedTokens.find(i=>i.id===e);if(!t)return!1;const n=O(),o=Oe();if(o.receiveData.tokensBase64=t.cashuToken,await o.receiveIfDecodes()){await k.markTokenClaimed({messageId:e});const i=this.unclaimedTokens.findIndex(a=>a.id===e);return i!==-1&&(this.unclaimedTokens[i]={...t,claimed:!0}),this.addContact(t.sender,t.senderPeerID),!0}else return!1}catch(t){const n=t?.message||t?.toString()||"";if(n.includes("Token already spent")||n.includes("already spent")){console.log(`Token ${e} already spent, removing from unclaimed list`);const o=this.unclaimedTokens.findIndex(s=>s.id===e);return o!==-1&&(this.unclaimedTokens.splice(o,1),console.log(`Removed already spent token ${e} from unclaimed list`)),!0}return!1}},handleEcashReceived(e){this.unclaimedTokens.find(n=>n.id===e.id)||(this.unclaimedTokens.push(e),P(`Received ${e.amount} ${e.unit} via Bluetooth!`,e.memo||"From nearby peer"),navigator.onLine&&this.claimToken(e.id))},handlePeerDiscovered(e){if(!this.nearbyPeers.find(n=>n.peerID===e.peerID))this.nearbyPeers.push(e),console.log(`New peer discovered: ${e.peerID} (${e.nickname||"unnamed"})`);else{const n=this.nearbyPeers.findIndex(o=>o.peerID===e.peerID);this.nearbyPeers[n]=e}},handlePeerLost(e){const t=this.nearbyPeers.findIndex(n=>n.peerID===e);t!==-1&&(this.nearbyPeers.splice(t,1),console.log(`Peer lost: ${e}`))},handleTokenSent(e){const t=this.pendingMessages.indexOf(e);t!==-1&&this.pendingMessages.splice(t,1)},handleTokenDelivered(e,t){console.log(`Token ${e} delivered to ${t}`)},handleFavoriteNotification(e,t,n){console.log(`\u2B50\uFE0F ${n?"FAVORITED":"UNFAVORITED"} by ${e} with npub: ${t.substring(0,16)}...`);const o=J();o.updateNostrNpub(e,t),n?o.updatePeerFavoritedUs(e,!0):o.updatePeerFavoritedUs(e,!1);const i=this.nearbyPeers.find(a=>a.peerID===e)?.nickname||e.substring(0,8);n&&(o.isMutualFavorite(e)?P(`\u{1F495} Mutual favorite with ${i}! You can now message via Nostr.`):P(`\u2B50\uFE0F ${i} added you as favorite. Favorite back for Nostr messaging!`))},handleFavoriteRequest(e,t,n){console.log("\u{1F4EC} [HANDLER] handleFavoriteRequest called"),console.log(`\u{1F4EC} Favorite request from ${t} (${e}) with npub: ${n.substring(0,16)}...`);const o=J();console.log("\u{1F4EC} [HANDLER] Adding pending request to store..."),o.addPendingRequest(e,t,n),console.log("\u{1F4EC} [HANDLER] Pending request added. Count:",o.pendingCount),console.log("\u{1F4EC} [HANDLER] Showing notification..."),P(`\u{1F4EC} ${t} wants to be your favorite!`,{timeout:5e3,actions:[{label:"View",color:"white",handler:()=>{console.log("\u{1F4EC} [NOTIFICATION] View action clicked")}}]})},handleFavoriteAccepted(e,t){console.log(`\u2705 Favorite accepted by ${e} with npub: ${t.substring(0,16)}...`);const n=J();if(n.favorites[e])console.log(`\u2705 Updating existing favorite npub for ${e}`),n.updateNostrNpub(e,t);else{const i=this.nearbyPeers.find(a=>a.peerID===e);console.log(`\u2705 Creating favorite for ${e} before updating npub`),n.addFavorite(e,i?.nickname||"Unknown",t)}n.updatePeerFavoritedUs(e,!0);const s=this.nearbyPeers.find(i=>i.peerID===e)?.nickname||e.substring(0,8);P(`\u{1F495} ${s} accepted your favorite request! You can now message via Nostr.`)},async startPeerPolling(){if(!this.isActive)return;const e=async()=>{if(!!this.isActive)try{const{peers:t}=await k.getAvailablePeers();this.nearbyPeers=t,setTimeout(e,5e3)}catch(t){console.error("Failed to poll peers:",t),setTimeout(e,1e4)}};e()},addContact(e,t){if(!this.contacts.find(o=>o.npub===e))this.contacts.push({npub:e,peerID:t,addedAt:Date.now(),lastInteraction:Date.now(),nickname:""}),console.log(`Added contact: ${e}`),navigator.onLine&&this.syncContactsToNostr();else{const o=this.contacts.findIndex(s=>s.npub===e);this.contacts[o].lastInteraction=Date.now()}},async syncContactsToNostr(){try{const e=x();console.log("Contacts sync to Nostr planned for future release",this.contacts.length,"contacts")}catch(e){console.error("Failed to sync contacts to Nostr:",e)}},async startAlwaysOnMode(){if(!H.isNativePlatform()){j("Always-on mode is only available on Android devices");return}try{const e=await k.startAlwaysOnMode();e.success?(this.alwaysOnActive=!0,P("Always-on mode started. Bluetooth mesh will stay active 24/7."),console.log("Always-on mode started:",e.message)):p("Failed to start always-on mode")}catch(e){console.error("Error starting always-on mode:",e),p(`Failed to start always-on mode: ${e.message}`)}},async stopAlwaysOnMode(){if(!H.isNativePlatform()){j("Always-on mode is only available on Android devices");return}try{const e=await k.stopAlwaysOnMode();e.success?(this.alwaysOnActive=!1,this.alwaysOnEnabled=!1,P("Always-on mode stopped"),console.log("Always-on mode stopped:",e.message)):p("Failed to stop always-on mode")}catch(e){console.error("Error stopping always-on mode:",e),p(`Failed to stop always-on mode: ${e.message}`)}},async checkAlwaysOnStatus(){if(!H.isNativePlatform()){this.alwaysOnActive=!1;return}try{const e=await k.isAlwaysOnActive();this.alwaysOnActive=e.isActive,console.log("Always-on status checked:",this.alwaysOnActive)}catch(e){console.error("Error checking always-on status:",e),this.alwaysOnActive=!1}},async toggleAlwaysOnMode(e){this.alwaysOnEnabled=e,e?await this.startAlwaysOnMode():await this.stopAlwaysOnMode()},async requestBatteryOptimizationExemption(){if(!H.isNativePlatform()){j("Battery optimization settings are only available on Android devices");return}try{const e=await k.requestBatteryOptimizationExemption();e.success?(P("Battery optimization dialog opened. Please allow Bitpoints to run in background."),console.log("Battery optimization exemption requested:",e.message)):p("Failed to open battery optimization settings")}catch(e){console.error("Error requesting battery optimization exemption:",e),p(`Failed to open battery settings: ${e.message}`)}}}});const Kn=te({name:"NearbyContactsDialog",emits:["close"],setup(e,{emit:t}){const n=st(),o=J(),s=O(),i=V(),a=Te(),l=Ze(),u=x(),d=I(new Set),f=I(null),y=I(""),g=I(!1),$=L(()=>n.sortedPeers),D=L(()=>i.activeUnit),K=m=>{d.value.has(m.peerID)?d.value.delete(m.peerID):d.value.add(m.peerID),d.value=new Set(d.value)},oe=async()=>{await n.startService()},qe=async()=>{if(!f.value||f.value<=0){p("Please enter a valid amount");return}if(d.value.size===0){p("Please select at least one peer");return}g.value=!0;try{const m=Math.floor(f.value*i.activeUnitCurrencyMultiplyer),C=s.mintWallet(i.activeMintUrl,i.activeUnit),N=i.activeProofs||[];if(N.length===0){p("No tokens available. Please receive tokens first."),g.value=!1;return}const{sendProofs:W}=await s.send(N,C,m,!0,!1),Y=a.serializeProofs(W);let G=0;for(const Re of d.value){console.log("\u{1F7E2} [UI] About to call bluetoothStore.sendToken for peer:",Re),console.log("\u{1F7E2} [UI] Token:",Y.substring(0,50)+"..."),console.log("\u{1F7E2} [UI] Amount:",m,D.value);const Ie=await n.sendToken({token:Y,amount:m,unit:D.value,mint:i.activeMintUrl,peerID:Re,memo:y.value||void 0,senderNpub:u.pubkey||""});console.log("\u{1F7E2} [UI] sendToken returned:",Ie),Ie&&G++}G>0&&(l.addPendingToken({amount:m,token:Y,mint:i.activeMintUrl,unit:D.value,label:y.value?`\u{1F4E1} Bluetooth: ${y.value}`:"\u{1F4E1} Sent via Bluetooth"}),P(`Sent ${f.value} ${D.value} to ${G} peer${G!==1?"s":""}`),f.value=null,y.value="",d.value.clear(),t("close"))}catch(m){console.error("Failed to send tokens:",m),p("Failed to send tokens")}finally{g.value=!1}},Ee=async()=>{if(!f.value||f.value<=0){p("Please enter a valid amount");return}g.value=!0;try{const m=Math.floor(f.value*i.activeUnitCurrencyMultiplyer),C=s.mintWallet(i.activeMintUrl,i.activeUnit),N=i.activeProofs||[];if(N.length===0){p("No tokens available. Please receive tokens first."),g.value=!1;return}const{sendProofs:W}=await s.send(N,C,m,!0,!1),Y=a.serializeProofs(W);await n.sendToken({token:Y,amount:m,unit:D.value,mint:i.activeMintUrl,memo:y.value||void 0,senderNpub:u.pubkey||""})&&(l.addPendingToken({amount:m,token:Y,mint:i.activeMintUrl,unit:D.value,label:y.value?`\u{1F4E1} Broadcast: ${y.value}`:"\u{1F4E1} Broadcast via Bluetooth"}),P(`Broadcasting ${f.value} ${D.value} to all nearby devices`),f.value=null,y.value="",t("close"))}catch(m){console.error("Failed to broadcast tokens:",m),p("Failed to broadcast tokens")}finally{g.value=!1}},_=m=>{const C=Math.floor((Date.now()-m)/1e3);return C<60?"Just now":C<3600?`${Math.floor(C/60)}m ago`:C<86400?`${Math.floor(C/3600)}h ago`:`${Math.floor(C/86400)}d ago`},se=m=>o.isFavorite(m);return{bluetoothStore:n,nearbyPeers:$,selectedPeers:d,amount:f,memo:y,sending:g,unit:D,isFavorite:se,isMutualFavorite:m=>o.isMutualFavorite(m),toggleFavorite:async m=>{if(se(m.peerID)){o.removeFavorite(m.peerID);try{u.seedSignerPublicKey||await u.walletSeedGenerateKeyPair();const N=u.seedSignerPublicKey||u.pubkey;if(N){const W=N.startsWith("npub")?N:me.npubEncode(N);await n.sendTextMessage(m.peerID,`[UNFAVORITED]:${W}`),console.log(`\u{1F4E4} Sent unfavorite notification to ${m.nickname} with npub: ${W.substring(0,16)}...`)}}catch(N){console.error("Failed to send unfavorite notification:",N)}P(`Removed ${m.nickname} from favorites`)}else{o.addFavorite(m.peerID,m.nickname||"Unknown",m.nostrNpub||null);try{u.seedSignerPublicKey||await u.walletSeedGenerateKeyPair();const N=u.seedSignerPublicKey||u.pubkey;if(N){const W=N.startsWith("npub")?N:me.npubEncode(N);await n.sendTextMessage(m.peerID,`[FAVORITE_REQUEST]:${W}`),console.log(`\u{1F4E4} Sent favorite request to ${m.nickname} with npub: ${W.substring(0,16)}...`)}}catch(N){console.error("Failed to send favorite request:",N)}P(`Sent favorite request to ${m.nickname}`)}},togglePeerSelection:K,enableBluetooth:oe,sendToPeers:qe,broadcastToAll:Ee,formatLastSeen:_}}}),at=e=>(Ne("data-v-7c97bdb1"),e=e(),_e(),e),Qn={class:"nearby-contacts"},Hn={class:"q-pa-md"},jn=at(()=>w("h6",{class:"q-mt-none q-mb-md"},"Send to Nearby",-1)),Yn={key:1,class:"text-center q-py-xl"},Xn=at(()=>w("div",{class:"q-mt-md text-grey-7"},"Scanning for nearby devices...",-1)),Jn={class:"row items-center q-gutter-xs"},Gn={key:3,class:"q-mt-md"};function Zn(e,t,n,o,s,i){return h(),F("div",Qn,[w("div",Hn,[jn,e.bluetoothStore.isActive?M("",!0):(h(),E(nt,{key:0,class:"bg-warning text-dark q-mb-md",rounded:""},{avatar:c(()=>[r(S,{name:"bluetooth_disabled"})]),action:c(()=>[r(A,{flat:"",label:"Enable",onClick:e.enableBluetooth},null,8,["onClick"])]),default:c(()=>[v(" Bluetooth is off. Turn it on to send to nearby devices. ")]),_:1})),e.bluetoothStore.isActive&&e.nearbyPeers.length===0?(h(),F("div",Yn,[r(Pt,{size:"3em",color:"primary"}),Xn])):M("",!0),e.nearbyPeers.length>0?(h(),E($e,{key:2,bordered:"",separator:"",class:"rounded-borders"},{default:c(()=>[(h(!0),F(pe,null,ve(e.nearbyPeers,a=>Fe((h(),E(he,{key:a.peerID,clickable:"",onClick:l=>e.togglePeerSelection(a),class:Je({"bg-blue-1":e.selectedPeers.has(a.peerID)})},{default:c(()=>[r(U,{avatar:""},{default:c(()=>[r(De,{color:a.isDirect?"green":"orange","text-color":"white"},{default:c(()=>[r(S,{name:a.isDirect?"bluetooth_connected":"device_hub"},null,8,["name"])]),_:2},1032,["color"])]),_:2},1024),r(U,null,{default:c(()=>[r(R,null,{default:c(()=>[v(b(a.nickname||a.nostrNpub?.substring(0,16)||a.peerID.substring(0,8))+"... ",1),e.isMutualFavorite(a.peerID)?(h(),E(S,{key:0,name:"favorite",color:"pink",size:"xs",class:"q-ml-xs"},{default:c(()=>[r(z,null,{default:c(()=>[v("Mutual favorite")]),_:1})]),_:1})):M("",!0)]),_:2},1024),r(R,{caption:""},{default:c(()=>[v(b(a.isDirect?"Direct":"Via mesh")+" \u2022 "+b(e.formatLastSeen(a.lastSeen)),1)]),_:2},1024)]),_:2},1024),r(U,{side:""},{default:c(()=>[w("div",Jn,[r(A,{flat:"",dense:"",round:"",size:"sm",icon:e.isFavorite(a.peerID)?"favorite":"favorite_border",color:e.isFavorite(a.peerID)?"pink":"grey",onClick:ue(l=>e.toggleFavorite(a),["stop"])},{default:c(()=>[r(z,null,{default:c(()=>[v(b(e.isFavorite(a.peerID)?"Remove from favorites":"Add to favorites"),1)]),_:2},1024)]),_:2},1032,["icon","color","onClick"]),r(Nt,{"model-value":e.selectedPeers.has(a.peerID),onClick:ue(l=>e.togglePeerSelection(a),["stop"]),color:"primary"},null,8,["model-value","onClick"])])]),_:2},1024)]),_:2},1032,["onClick","class"])),[[Ge]])),128))]),_:1})):M("",!0),e.nearbyPeers.length>0?(h(),F("div",Gn,[r(de,{modelValue:e.amount,"onUpdate:modelValue":t[0]||(t[0]=a=>e.amount=a),modelModifiers:{number:!0},type:"number",label:"Amount",outlined:"",dense:"",suffix:e.unit,class:"q-mb-md",placeholder:"Enter amount"},{prepend:c(()=>[r(S,{name:"payments"})]),_:1},8,["modelValue","suffix"]),r(de,{modelValue:e.memo,"onUpdate:modelValue":t[1]||(t[1]=a=>e.memo=a),label:"Memo (optional)",outlined:"",dense:"",class:"q-mb-md",placeholder:"What's this for?"},{prepend:c(()=>[r(S,{name:"note"})]),_:1},8,["modelValue"]),r(A,{unelevated:"",color:"primary",class:"full-width",disable:e.selectedPeers.size===0||!e.amount||e.amount<=0||e.sending,loading:e.sending,onClick:e.sendToPeers},{default:c(()=>[r(S,{name:"send",class:"q-mr-sm"}),v(" Send "+b(e.amount||"")+" "+b(e.unit)+" to "+b(e.selectedPeers.size)+" peer"+b(e.selectedPeers.size!==1?"s":""),1)]),_:1},8,["disable","loading","onClick"]),r(A,{flat:"",color:"primary",class:"full-width q-mt-sm",disable:!e.amount||e.amount<=0||e.sending,loading:e.sending,onClick:e.broadcastToAll},{default:c(()=>[r(S,{name:"wifi_tethering",class:"q-mr-sm"}),v(" Broadcast to All Nearby ")]),_:1},8,["disable","loading","onClick"])])):M("",!0)])])}var Lo=ne(Kn,[["render",Zn],["__scopeId","data-v-7c97bdb1"]]);const eo=te({name:"NostrContactsDialog",setup(){const e=J(),t=x(),n=O(),o=V(),s=Te(),i=Ze(),a=I(null),l=I(!1),u=I(null),d=I(null),f=I(""),y=I(!1),g=L(()=>e.myFavorites),$=L(()=>o.activeUnit),D=_=>_?_.length>16?`${_.substring(0,16)}...`:_:"No Nostr key",K=_=>{u.value=_,d.value=null,f.value="",l.value=!0},oe=()=>{l.value=!1,u.value=null,d.value=null,f.value=""};return{contacts:g,selectedContact:a,showSendDialog:l,sendTarget:u,sendAmount:d,sendMemo:f,sending:y,unit:$,formatNpub:D,openSendDialog:K,closeSendDialog:oe,removeFavorite:_=>{e.removeFavorite(_.peerNoisePublicKey),P(`Removed ${_.peerNickname} from favorites`)},sendViaNostr:async()=>{if(!u.value||!u.value.peerNostrNpub){p("Contact does not have Nostr key");return}if(!d.value||d.value<=0){p("Please enter a valid amount");return}if(!t.pubkey){p("Nostr not configured. Please set up your Nostr key first.");return}y.value=!0;try{const _=Math.floor(d.value*o.activeUnitCurrencyMultiplyer),se=n.mintWallet(o.activeMintUrl,o.activeUnit),ye=o.activeProofs||[];if(ye.length===0){p("No tokens available. Please receive tokens first."),y.value=!1;return}const{sendProofs:Ae}=await n.send(ye,se,_,!0,!1),m=s.serializeProofs(Ae);i.addPendingToken({amount:_,token:m,mint:o.activeMintUrl,unit:$.value,label:f.value?`\u{1F4E1} Nostr: ${f.value}`:`\u{1F4E1} Sent to ${u.value.peerNickname} via Nostr`}),console.log("\u{1F4BE} Token saved to transaction history (can be recovered via QR)");let C=m;f.value&&(C+=`
---
Memo: ${f.value}
Amount: ${d.value} ${$.value}
From: ${t.pubkey.substring(0,16)}...`),console.log(`\u{1F4E4} Sending to npub: ${u.value.peerNostrNpub.substring(0,20)}...`),console.log(`\u{1F4E4} Message length: ${C.length} chars`),await t.sendNip04DirectMessage(u.value.peerNostrNpub,C),P(`Sent ${d.value} ${$.value} to ${u.value.peerNickname} via Nostr!`),oe()}catch(_){console.error("Failed to send via Nostr:",_),p(`Failed to send: ${_}`)}finally{y.value=!1}}}}}),Me=e=>(Ne("data-v-756a44b6"),e=e(),_e(),e),to={class:"nostr-contacts"},no={class:"q-pa-md"},oo=Me(()=>w("h6",{class:"q-mt-none q-mb-md"},"Nostr Contacts",-1)),so={key:0,class:"text-center q-py-xl"},ao=Me(()=>w("div",{class:"q-mt-md text-grey-7"},"No saved contacts yet",-1)),io=Me(()=>w("div",{class:"text-caption text-grey-6 q-mt-sm"}," Add favorites from nearby peers to send via Nostr ",-1)),ro={key:0},lo={key:1,class:"text-warning"},co={class:"row items-center q-gutter-xs"},uo={class:"text-h6"};function mo(e,t,n,o,s,i){return h(),F("div",to,[w("div",no,[oo,e.contacts.length===0?(h(),F("div",so,[r(S,{name:"person_off",size:"4em",color:"grey-5"}),ao,io])):M("",!0),e.contacts.length>0?(h(),E($e,{key:1,bordered:"",separator:"",class:"rounded-borders"},{default:c(()=>[(h(!0),F(pe,null,ve(e.contacts,a=>Fe((h(),E(he,{key:a.peerNoisePublicKey,clickable:"",onClick:l=>e.selectedContact=a,class:Je({"bg-blue-1":e.selectedContact?.peerNoisePublicKey===a.peerNoisePublicKey})},{default:c(()=>[r(U,{avatar:""},{default:c(()=>[r(De,{color:"primary","text-color":"white"},{default:c(()=>[r(S,{name:a.theyFavoritedUs?"favorite":"person"},null,8,["name"])]),_:2},1024)]),_:2},1024),r(U,null,{default:c(()=>[r(R,null,{default:c(()=>[v(b(a.peerNickname)+" ",1),a.theyFavoritedUs?(h(),E(S,{key:0,name:"favorite",color:"pink",size:"xs",class:"q-ml-xs"},{default:c(()=>[r(z,null,{default:c(()=>[v("Mutual favorite")]),_:1})]),_:1})):M("",!0)]),_:2},1024),r(R,{caption:""},{default:c(()=>[a.peerNostrNpub?(h(),F("span",ro,b(e.formatNpub(a.peerNostrNpub)),1)):(h(),F("span",lo,[r(S,{name:"warning",size:"xs"}),v(" No Nostr key - Bluetooth only ")]))]),_:2},1024)]),_:2},1024),r(U,{side:""},{default:c(()=>[w("div",co,[r(A,{flat:"",dense:"",round:"",size:"sm",icon:"delete",color:"grey",onClick:ue(l=>e.removeFavorite(a),["stop"])},{default:c(()=>[r(z,null,{default:c(()=>[v("Remove from favorites")]),_:1})]),_:2},1032,["onClick"]),r(A,{flat:"",dense:"",round:"",icon:"send",color:a.peerNostrNpub?"primary":"grey",disable:!a.peerNostrNpub,onClick:ue(l=>e.openSendDialog(a),["stop"])},{default:c(()=>[r(z,null,{default:c(()=>[v(b(a.peerNostrNpub?"Send ecash via Nostr":"Nostr key required for remote send"),1)]),_:2},1024)]),_:2},1032,["color","disable","onClick"])])]),_:2},1024)]),_:2},1032,["onClick","class"])),[[Ge]])),128))]),_:1})):M("",!0),r(tt,{modelValue:e.showSendDialog,"onUpdate:modelValue":t[2]||(t[2]=a=>e.showSendDialog=a),persistent:""},{default:c(()=>[r(et,{style:{"min-width":"400px"}},{default:c(()=>[r(Pe,{class:"row items-center"},{default:c(()=>[r(S,{name:"send",color:"primary",size:"md",class:"q-mr-sm"}),w("span",uo,"Send to "+b(e.sendTarget?.peerNickname),1)]),_:1}),r(Pe,null,{default:c(()=>[r(de,{modelValue:e.sendAmount,"onUpdate:modelValue":t[0]||(t[0]=a=>e.sendAmount=a),modelModifiers:{number:!0},type:"number",label:"Amount",outlined:"",dense:"",suffix:e.unit,class:"q-mb-md",autofocus:"",placeholder:"Enter amount"},{prepend:c(()=>[r(S,{name:"payments"})]),_:1},8,["modelValue","suffix"]),r(de,{modelValue:e.sendMemo,"onUpdate:modelValue":t[1]||(t[1]=a=>e.sendMemo=a),label:"Memo (optional)",outlined:"",dense:"",class:"q-mb-md",placeholder:"What's this for?"},{prepend:c(()=>[r(S,{name:"note"})]),_:1},8,["modelValue"]),r(nt,{dense:"",class:"bg-info text-white q-mb-md",rounded:""},{avatar:c(()=>[r(S,{name:"info"})]),default:c(()=>[v(" Sending via Nostr - no Bluetooth connection needed ")]),_:1})]),_:1}),r($t,{align:"right",class:"q-pa-md"},{default:c(()=>[r(A,{flat:"",round:"",icon:"close",color:"grey",onClick:e.closeSendDialog},{default:c(()=>[r(z,null,{default:c(()=>[v("Close")]),_:1})]),_:1},8,["onClick"]),r(A,{color:"primary",label:"Send",onClick:e.sendViaNostr,loading:e.sending,disable:!e.sendAmount||e.sendAmount<=0},null,8,["onClick","loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])])}var zo=ne(eo,[["render",mo],["__scopeId","data-v-756a44b6"]]);const ho=te({name:"FavoriteRequestsDialog",setup(){const e=J(),t=st(),n=x();return{pendingRequests:L(()=>e.pendingRequestsList),formatNpub:u=>u?`${u.substring(0,12)}...${u.substring(u.length-4)}`:"No Nostr key",formatTime:u=>{try{return Pn(new Date(u),{addSuffix:!0})}catch{return"Recently"}},acceptRequest:async u=>{try{e.acceptPendingRequest(u.peerNoisePublicKey),n.seedSignerPublicKey||await n.walletSeedGenerateKeyPair();const d=n.seedSignerPublicKey||n.pubkey;if(d){const f=d.startsWith("npub")?d:me.npubEncode(d);await t.sendTextMessage(u.peerNoisePublicKey,`[FAVORITE_ACCEPTED]:${f}`),console.log(`\u{1F4E4} Sent favorite acceptance to ${u.peerNickname} with npub: ${f.substring(0,16)}...`)}P(`\u{1F495} You and ${u.peerNickname} are now mutual favorites!`)}catch(d){console.error("Failed to accept favorite request:",d)}},ignoreRequest:u=>{e.removePendingRequest(u.peerNoisePublicKey),P(`Ignored request from ${u.peerNickname}`)}}}}),Ce=e=>(Ne("data-v-7a5de990"),e=e(),_e(),e),fo={class:"favorite-requests"},po={class:"q-pa-md"},vo=Ce(()=>w("h6",{class:"q-mt-none q-mb-md"},"Favorite Requests",-1)),go={key:0,class:"text-center q-py-xl"},yo=Ce(()=>w("div",{class:"q-mt-md text-grey-7"},"No pending requests",-1)),bo=Ce(()=>w("div",{class:"text-caption text-grey-6 q-mt-sm"}," When someone favorites you, it will appear here ",-1)),wo={class:"row items-center q-gutter-xs"};function ko(e,t,n,o,s,i){return h(),F("div",fo,[w("div",po,[vo,e.pendingRequests.length===0?(h(),F("div",go,[r(S,{name:"inbox",size:"4em",color:"grey-5"}),yo,bo])):M("",!0),e.pendingRequests.length>0?(h(),E($e,{key:1,bordered:"",separator:"",class:"rounded-borders"},{default:c(()=>[(h(!0),F(pe,null,ve(e.pendingRequests,a=>(h(),E(he,{key:a.peerNoisePublicKey},{default:c(()=>[r(U,{avatar:""},{default:c(()=>[r(De,{color:"primary","text-color":"white"},{default:c(()=>[r(S,{name:"person_add"})]),_:1})]),_:1}),r(U,null,{default:c(()=>[r(R,null,{default:c(()=>[v(b(a.peerNickname),1)]),_:2},1024),r(R,{caption:""},{default:c(()=>[v(b(e.formatNpub(a.peerNostrNpub)),1)]),_:2},1024),r(R,{caption:"",class:"text-grey-6 q-mt-xs"},{default:c(()=>[v(b(e.formatTime(a.receivedAt)),1)]),_:2},1024)]),_:2},1024),r(U,{side:""},{default:c(()=>[w("div",wo,[r(A,{flat:"",dense:"",round:"",size:"sm",icon:"check",color:"positive",onClick:l=>e.acceptRequest(a)},{default:c(()=>[r(z,null,{default:c(()=>[v("Accept")]),_:1})]),_:2},1032,["onClick"]),r(A,{flat:"",dense:"",round:"",size:"sm",icon:"close",color:"grey",onClick:l=>e.ignoreRequest(a)},{default:c(()=>[r(z,null,{default:c(()=>[v("Ignore")]),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})):M("",!0)])])}var Ko=ne(ho,[["render",ko],["__scopeId","data-v-7a5de990"]]);const le={NWCInfo:13194,NWCRequest:23194,NWCResponse:23195},Qo=ge("nwc",{state:()=>({nwcEnabled:q("cashu.nwc.enabled",!1),connections:q("cashu.nwc.connections",[]),seenCommandsUntil:q("cashu.nwc.seenCommandsUntil",0),supportedMethods:["pay_invoice","make_invoice","get_balance","get_info","list_transactions","lookup_invoice"],blocking:!1,ndk:new ke,subscriptions:[],showNWCDialog:!1,showNWCData:{connection:{},connectionString:""}}),getters:{},actions:{handleGetInfo:async function(e){return console.log("### get_info",e.method),{result_type:"get_info",result:{alias:"Cashu.me",color:"#FF0000",pubkey:this.connections[0].walletPublicKey,network:"mainnet",block_height:1,block_hash:"blockchain disrespectoor",methods:this.supportedMethods}}},handleGetBalance:async function(e){const t=V();return console.log("### get_balance",e.method),{result_type:"get_balance",result:{balance:t.totalUnitBalance*1e3}}},handlePayInvoice:async function(e){const t=e.params.invoice,n=e.params.amount;console.log("### pay_invoice",e.method),console.log("### invoice",t),console.log("### amountMsat",n);const o=O(),s=Te(),i=V();try{await o.decodeRequest(t)}catch(l){return console.log("### error decoding invoice",l),{result_type:e.method,error:{code:"INTERNAL",message:"Invalid invoice"}}}if(o.payInvoiceData.meltQuote.response.amount==0||o.payInvoiceData.meltQuote.error)return j("NWC: Error requesting melt quote"),{result_type:e.method,error:{code:"INTERNAL",message:"Error requesting melt quote"}};const a=o.payInvoiceData.meltQuote.response.amount+o.payInvoiceData.meltQuote.response.fee_reserve;if(i.activeUnit!="sat")return j("NWC: Active unit must be sats"),{result_type:e.method,error:{code:"INTERNAL",message:"Your active must be sats"}};if(a>this.connections[0].allowanceLeft)return j("NWC: Allowance exceeded"),{result_type:e.method,error:{code:"QUOTA_EXCEEDED",message:"Your quota has exceeded"}};try{const l=await o.meltInvoiceData(),u=o.payInvoiceData.meltQuote.response.amount+o.payInvoiceData.meltQuote.response.fee_reserve-s.sumProofs(l.change);return this.connections[0].allowanceLeft-=u,{result_type:e.method,result:{}}}catch{return{result_type:e.method,error:{code:"INTERNAL",message:"Could not pay invoice"}}}},handleMakeInvoice:async function(e){const{amount:t,description:n,expiry:o}=e.params;console.log("### make_invoice"),console.log("### amount",t),console.log("### description",n),console.log("### expiry",o);const s=O(),i=await s.requestMint(t/1e3,s.wallet);return i?(s.mintOnPaid(i.quote,!1,!0),{result_type:e.method,result:{type:"incoming",invoice:i?.request,description:n,amount:t}}):{result_type:e.method,error:{code:"INTERNAL",message:"failed to request mint invoice"}}},handleListTransactions:async function(e){console.log("### list_transactions",e.method);const t=O(),n=e.params.from||0,o=e.params.until||Math.floor(Date.now()/1e3),s=e.params.limit||10,i=e.params.offset||0,a=e.params.unpaid||!1,l=e.params.type||void 0,f=t.invoiceHistory.filter(y=>{const g=new Date(y.date),$=Math.floor(g.getTime()/1e3);return!(n&&$<n||o&&$>o||l&&l=="incoming"&&y.amount<0||l&&l=="outgoing"&&y.amount>0||a&&y.status=="paid")}).slice(i,i+s).map(this.mapToNwcTransaction).sort((y,g)=>g.created_at-y.created_at);return{result_type:"list_transactions",result:{transactions:f}}},handleLookupInvoice:async function(e){let t=e.params.payment_hash;if(!t){const s=e.params.invoice;t=(s?Ve.decode(s):null)?.sections.find(a=>a.name==="payment_hash")?.value}if(!t)return{result_type:e.method,error:{code:"OTHER",message:"invoice or payment_hash required"}};console.log("### lookup_invoice");const o=O().invoiceHistory;for(const s of o)if(Ve.decode(e.params.invoice).sections.find(l=>l.name==="payment_hash")?.value===t)return{result_type:e.method,result:this.mapToNwcTransaction(s)};return{result_type:e.method,error:{code:"NOT_FOUND",message:"invoice not found"}}},mapToNwcTransaction(e){let t=e.amount>0?"incoming":"outgoing",n=Math.abs(e.amount)*1e3,o=Math.floor(new Date(e.date).getTime()/1e3),s=e.status=="paid"?Math.floor(new Date(e.date).getTime()/1e3):null;return{type:t,invoice:e.bolt11,description:e.memo,amount:n,fees_paid:0,created_at:o,settled_at:s}},replyNWC:async function(e,t,n){let o=new Se(t.ndk);o.kind=23195,console.log("### replying with",JSON.stringify(e)),o.content=await xe.encrypt(n.walletPrivateKey,t.author.pubkey,JSON.stringify(e)),o.tags=[["p",t.author.pubkey],["e",t.id]],console.log("### replyEvent",o),console.log("### replying to",t.id),await o.publish()},parseNWCCommand:async function(e,t,n){let o=JSON.parse(e),s;if(console.log("### nwcCommand",o),o.method=="get_info")s=await this.handleGetInfo(o);else if(o.method=="get_balance")s=await this.handleGetBalance(o);else if(o.method=="pay_invoice"){this.blocking&&(s={result_type:o.method,error:{code:"INTERNAL",message:"Already processing a payment."}}),this.blocking=!0;try{s=await this.handlePayInvoice(o)}catch{return}finally{this.blocking=!1}}else o.method==="make_invoice"?s=await this.handleMakeInvoice(o):o.method=="list_transactions"?s=await this.handleListTransactions(o):o.method==="lookup_invoice"?s=await this.handleLookupInvoice(o):(console.log("### method not supported",o.method),s={result_type:o.method,error:{code:"NOT_IMPLEMENTED",message:"Method not supported"}});await this.replyNWC(s,t,n)},getConnectionString:function(e){const t=e.walletPublicKey,n=e.connectionSecret,o=x();return`nostr+walletconnect://${t}?relay=${o.relays.join("&relay=")}&secret=${n}`},generateNWCConnection:async function(){let e;if(this.connections.length)e=this.connections[0];else{const s=Le(),i=ze(s),a=Ke(s),l=Le(),u=ze(l),d=Ke(l);e={walletPublicKey:i,walletPrivateKey:a,connectionSecret:d,connectionPublicKey:u,allowanceLeft:1e3},this.connections=this.connections.concat(e)}const t=new vt(e.walletPrivateKey);this.unsubscribeNWC();const n=x();this.ndk=new ke({explicitRelayUrls:n.relays,signer:t}),this.ndk.connect();const o=new Se(this.ndk);o.kind=le.NWCInfo,o.content=this.supportedMethods.join(" ");try{let s={kinds:[le.NWCInfo],authors:[e.walletPublicKey]};(await this.ndk.fetchEvents(s)).size===0?(await o.publish(),console.log("### published nip47InfoEvent",o)):console.log("### nip47InfoEvent already published")}catch(s){console.log("### could not publish nip47InfoEvent",o),console.log("### error",s)}},listenToNWCCommands:async function(){await this.generateNWCConnection();const e=this.connections[0],n=Math.floor(Date.now()/1e3)-60;let o={kinds:[le.NWCRequest],since:n,authors:[e.connectionPublicKey],"#p":[e.walletPublicKey]};const s=this.ndk.subscribe(o),i=x();console.log("### subscribing to NWC on relays: ",i.relays),this.subscriptions.push(s),s.on("eose",()=>console.log("All relays have reached the end of the event stream")),s.on("close",()=>console.log("Subscription closed")),s.on("event",async a=>{if(a.kind!=le.NWCRequest)return;if(!this.nwcEnabled){console.log("### Received NWC command but NWC is disabled");return}if(a.created_at<=this.seenCommandsUntil)return;this.seenCommandsUntil=a.created_at,console.log("### NWC request!"),console.log("### event",a);const l=await xe.decrypt(e.connectionSecret,e.walletPublicKey,a.content);await this.parseNWCCommand(l,a,e)})},unsubscribeNWC:function(){console.log("### unsubscribing from NWC");for(let e of this.subscriptions)e.stop();this.subscriptions=[]}}}),So=27235,Ho=ge("npcV2",{state:()=>({npcV2Enabled:q("cashu.npc.v2.enabled",!1),npcV2ClaimAutomatically:q("cashu.npc.v2.claimAutomatically",!0),npcV2LastCheck:q("cashu.npc.v2.lastCheck",null),npcV2Address:q("cashu.npc.v2.address",""),npcV2Mint:q("cashu.npc.v2.mint",null),npcV2Domain:"",npcV2BaseURL:q("cashu.npc.v2.baseURL","https://npubx.cash"),npcV2Loading:!1}),getters:{},actions:{generateNPCV2Connection:async function(){if(!this.npcV2Enabled)return;const e=x(),t=V();if(!e.pubkey)return;const n=e.pubkey;this.npcV2Domain=new URL(this.npcV2BaseURL).hostname,this.npcV2Address=me.npubEncode(n)+"@"+this.npcV2Domain,this.npcV2Loading=!0;try{const o=this.npcV2Address,s=await this.getV2Info();if(s.name){const i=s.name+"@"+this.npcV2Domain;o!==i&&P(`Logged in as ${s.name}`),this.npcV2Address=i}t.mints.map(i=>i.url).includes(s.mintUrl)?this.npcV2Mint=s.mintUrl:t.activeMintUrl?await this.changeMintUrl(t.activeMintUrl):(await t.addMint({url:s.mintUrl}),this.npcV2Mint=s.mintUrl)}catch(o){o instanceof Error&&gt(o),console.log(o)}finally{this.npcV2Loading=!1}},getV2Info:async function(){try{const t=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/info`)).json();if(t.error)throw p(t.message),new Error(t.message);return t.data.user}catch(e){return console.error(e),{mintUrl:"",name:"",pubkey:"",lockQuote:!1}}},changeMintUrl:async function(e){if(!V().mints.find(n=>n.url===e)){p(`Please make sure ${e} is added to your wallet first!`,"Could not update npubx.cash mint");return}try{const o=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/mint`,{headers:{"Content-Type":"application/json"},method:"PATCH",body:JSON.stringify({mint_url:e})})).json();if(o.error)throw new Error(o.message);this.npcV2Mint=o.data.user.mintUrl}catch(n){console.log(n),n instanceof Error?p(n.message):p("Something went wrong!")}},getLatestQuotes:async function(){if(!this.npcV2Enabled)return;const e=O(),t=this.npcV2LastCheck?`?since=${this.npcV2LastCheck}`:"",n=`${this.npcV2BaseURL}/api/v2/wallet/quotes`;try{const s=await(await this.sendAuthedRequest(n+t,void 0,n)).json();if(s.error)return;let i;s.data.quotes.forEach(async a=>{e.invoiceHistory.find(l=>l.quote===a.quoteId)||((!i||i<a.createdAt)&&(i=a.createdAt),await e.invoiceHistory.push({label:"Zap",mint:a.mintUrl,memo:"",bolt11:a.request,amount:a.amount,quote:a.quoteId,date:yt.formatDate(new Date(a.createdAt*1e3),"YYYY-MM-DD HH:mm:ss"),status:"pending",unit:"sat",mintQuote:{request:a.request,quote:a.quoteId,state:bt.PAID,expiry:a.expiresAt,amount:a.amount,unit:"sat"}}),this.npcV2ClaimAutomatically&&await e.mintOnPaid(a.quoteId))}),i&&(this.npcV2LastCheck=i)}catch(o){console.error(o);return}},getUsernameQuote:async function(e){const t=await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}),n=await t.json();if(n.error){if(t.status===402){const o=t.headers.get("X-Cashu");if(!o)throw new Error("Unexpected reply without payment request");return{username:e,creq:o}}throw new Error(n.message)}throw new Error("Unexpected reply without payment request")},setUsername:async function(e,t){try{const o=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/username`,{method:"POST",headers:{"Content-Type":"application/json","X-Cashu":t},body:JSON.stringify({username:e})})).json();if(o.error)throw new Error(o.message);this.npcV2Address=`${o.data.user.name}@${this.npcV2Domain}`}catch(n){console.log(n),n instanceof Error&&p(n.message)}},sendAuthedRequest:async function(e,t,n){const o=await this.generateNip98Event(n||e,t?.method||"GET");return fetch(e,{...t,headers:{...t?.headers,authorization:`Nostr ${o}`}})},generateNip98Event:async function(e,t){const n=x();await n.initSignerIfNotSet();const o=new Se(new ke);o.kind=So,o.content="",o.tags=[["u",e],["method",t]],await o.sign(n.signer);const s=JSON.stringify(o.rawEvent());return btoa(s)}}});export{Vo as C,Ko as F,Lo as N,xo as P,Pe as Q,$t as a,Wo as b,Fn as c,nt as d,zo as e,Pn as f,J as g,Qo as h,Ho as i,Oo as m,st as u};
