import{x as H,aO as Ee,aP as Ne,l as L,j as S,y as W,V as R,h as se,at as be,au as we,av as ke,E as ae,G as g,H as T,J as _,M as k,O as N,t as l,aQ as $e,I as c,L as I,S as b,aR as Ce,aS as qe,aA as re,F as Pe,aw as Se,W as Ae,Q as V,B as Re,f as Ie,a as G,aB as Be,aG as xe,aH as Le}from"./index.51f2b46b.js";import{u as We,a as Oe,b as Ue}from"./QCheckbox.681ba086.js";import{a as _e,b as Y,Q as $}from"./QItem.b906d612.js";import{Q as K}from"./QBadge.afd40254.js";import{a as Ve}from"./welcome.41a750b0.js";import{b as He}from"./QSelect.b95fad3e.js";import{g as le}from"./QInput.50fcf8ad.js";import{b as B,M as ce,h as ee,y as E,r as Ke,G as De,p,v as w,w as q,H as u,f as A,k as de,g as x,z as Te,N as ne,x as je,I as ue,J as oe,K as he,L as me,O as fe,Q as ge,R as ze,T as Qe,V as Ye,W as Xe}from"./ui.f9c7454a.js";import{i as Je}from"./i18n.79f7761c.js";import{u as Ge,b as Ze,Q as pe}from"./QSpinnerDots.e67e540c.js";import{Q as et,a as tt}from"./QDialog.4aac6bf6.js";import{C as nt}from"./QSpinnerHourglass.d9a54d40.js";import{i as ot}from"./vue-qrcode.esm.527d4b00.js";import{a as st,c as at}from"./use-timeout.040996d9.js";import{Q as it}from"./QList.cb9031bc.js";import{u as y}from"./branding.c750d619.js";var Jn=H({name:"QCardActions",props:{...Ee,vertical:Boolean},setup(e,{slots:t}){const n=Ne(e),o=L(()=>`q-card__actions ${n.value} q-card__actions--${e.vertical===!0?"vert column":"horiz row"}`);return()=>S("div",{class:o.value},W(t.default))}}),rt=H({name:"QCardSection",props:{tag:{type:String,default:"div"},horizontal:Boolean},setup(e,{slots:t}){const n=L(()=>`q-card__section q-card__section--${e.horizontal===!0?"horiz row no-wrap":"vert"}`);return()=>S(e.tag,{class:n.value},W(t.default))}}),Gn=H({name:"QToggle",props:{...We,icon:String,iconColor:String},emits:Oe,setup(e){function t(n,o){const s=L(()=>(n.value===!0?e.checkedIcon:o.value===!0?e.indeterminateIcon:e.uncheckedIcon)||e.icon),a=L(()=>n.value===!0?e.iconColor:null);return()=>[S("div",{class:"q-toggle__track"}),S("div",{class:"q-toggle__thumb absolute flex flex-center no-wrap"},s.value!==void 0?[S(R,{name:s.value,color:a.value})]:void 0)]}return Ue("toggle",t)}});function v(e){const t=Object.prototype.toString.call(e);return e instanceof Date||typeof e=="object"&&t==="[object Date]"?new e.constructor(+e):typeof e=="number"||t==="[object Number]"||typeof e=="string"||t==="[object String]"?new Date(e):new Date(NaN)}function lt(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}const Zn=6e4,eo=36e5,j=43200,ve=1440;let ct={};function dt(){return ct}function ye(e){const t=v(e),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return n.setUTCFullYear(t.getFullYear()),+e-+n}function X(e,t){const n=v(e),o=v(t),s=n.getTime()-o.getTime();return s<0?-1:s>0?1:s}function ut(e){return lt(e,Date.now())}function ht(e,t){const n=v(e),o=v(t),s=n.getFullYear()-o.getFullYear(),a=n.getMonth()-o.getMonth();return s*12+a}function mt(e){return t=>{const o=(e?Math[e]:Math.trunc)(t);return o===0?0:o}}function ft(e,t){return+v(e)-+v(t)}function gt(e){const t=v(e);return t.setHours(23,59,59,999),t}function pt(e){const t=v(e),n=t.getMonth();return t.setFullYear(t.getFullYear(),n+1,0),t.setHours(23,59,59,999),t}function vt(e){const t=v(e);return+gt(t)==+pt(t)}function yt(e,t){const n=v(e),o=v(t),s=X(n,o),a=Math.abs(ht(n,o));let i;if(a<1)i=0;else{n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-s*a);let r=X(n,o)===-s;vt(v(e))&&a===1&&X(e,o)===1&&(r=!1),i=s*(a-Number(r))}return i===0?0:i}function bt(e,t,n){const o=ft(e,t)/1e3;return mt(n?.roundingMethod)(o)}const wt={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},kt=(e,t,n)=>{let o;const s=wt[e];return typeof s=="string"?o=s:t===1?o=s.one:o=s.other.replace("{{count}}",t.toString()),n?.addSuffix?n.comparison&&n.comparison>0?"in "+o:o+" ago":o};function te(e){return(t={})=>{const n=t.width?String(t.width):e.defaultWidth;return e.formats[n]||e.formats[e.defaultWidth]}}const Pt={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},St={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},_t={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Dt={date:te({formats:Pt,defaultWidth:"full"}),time:te({formats:St,defaultWidth:"full"}),dateTime:te({formats:_t,defaultWidth:"full"})},Tt={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Ft=(e,t,n,o)=>Tt[e];function O(e){return(t,n)=>{const o=n?.context?String(n.context):"standalone";let s;if(o==="formatting"&&e.formattingValues){const i=e.defaultFormattingWidth||e.defaultWidth,r=n?.width?String(n.width):i;s=e.formattingValues[r]||e.formattingValues[i]}else{const i=e.defaultWidth,r=n?.width?String(n.width):e.defaultWidth;s=e.values[r]||e.values[i]}const a=e.argumentCallback?e.argumentCallback(t):t;return s[a]}}const Mt={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Et={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Nt={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},$t={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Ct={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},qt={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},At=(e,t)=>{const n=Number(e),o=n%100;if(o>20||o<10)switch(o%10){case 1:return n+"st";case 2:return n+"nd";case 3:return n+"rd"}return n+"th"},Rt={ordinalNumber:At,era:O({values:Mt,defaultWidth:"wide"}),quarter:O({values:Et,defaultWidth:"wide",argumentCallback:e=>e-1}),month:O({values:Nt,defaultWidth:"wide"}),day:O({values:$t,defaultWidth:"wide"}),dayPeriod:O({values:Ct,defaultWidth:"wide",formattingValues:qt,defaultFormattingWidth:"wide"})};function U(e){return(t,n={})=>{const o=n.width,s=o&&e.matchPatterns[o]||e.matchPatterns[e.defaultMatchWidth],a=t.match(s);if(!a)return null;const i=a[0],r=o&&e.parsePatterns[o]||e.parsePatterns[e.defaultParseWidth],d=Array.isArray(r)?Bt(r,D=>D.test(i)):It(r,D=>D.test(i));let h;h=e.valueCallback?e.valueCallback(d):d,h=n.valueCallback?n.valueCallback(h):h;const P=t.slice(i.length);return{value:h,rest:P}}}function It(e,t){for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&t(e[n]))return n}function Bt(e,t){for(let n=0;n<e.length;n++)if(t(e[n]))return n}function xt(e){return(t,n={})=>{const o=t.match(e.matchPattern);if(!o)return null;const s=o[0],a=t.match(e.parsePattern);if(!a)return null;let i=e.valueCallback?e.valueCallback(a[0]):a[0];i=n.valueCallback?n.valueCallback(i):i;const r=t.slice(s.length);return{value:i,rest:r}}}const Lt=/^(\d+)(th|st|nd|rd)?/i,Wt=/\d+/i,Ot={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},Ut={any:[/^b/i,/^(a|c)/i]},Vt={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},Ht={any:[/1/i,/2/i,/3/i,/4/i]},Kt={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},jt={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},zt={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},Qt={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},Yt={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},Xt={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},Jt={ordinalNumber:xt({matchPattern:Lt,parsePattern:Wt,valueCallback:e=>parseInt(e,10)}),era:U({matchPatterns:Ot,defaultMatchWidth:"wide",parsePatterns:Ut,defaultParseWidth:"any"}),quarter:U({matchPatterns:Vt,defaultMatchWidth:"wide",parsePatterns:Ht,defaultParseWidth:"any",valueCallback:e=>e+1}),month:U({matchPatterns:Kt,defaultMatchWidth:"wide",parsePatterns:jt,defaultParseWidth:"any"}),day:U({matchPatterns:zt,defaultMatchWidth:"wide",parsePatterns:Qt,defaultParseWidth:"any"}),dayPeriod:U({matchPatterns:Yt,defaultMatchWidth:"any",parsePatterns:Xt,defaultParseWidth:"any"})},Gt={code:"en-US",formatDistance:kt,formatLong:Dt,formatRelative:Ft,localize:Rt,match:Jt,options:{weekStartsOn:0,firstWeekContainsDate:1}};function Zt(e,t,n){const o=dt(),s=n?.locale??o.locale??Gt,a=2520,i=X(e,t);if(isNaN(i))throw new RangeError("Invalid time value");const r=Object.assign({},n,{addSuffix:n?.addSuffix,comparison:i});let d,h;i>0?(d=v(t),h=v(e)):(d=v(e),h=v(t));const P=bt(h,d),D=(ye(h)-ye(d))/1e3,f=Math.round((P-D)/60);let F;if(f<2)return n?.includeSeconds?P<5?s.formatDistance("lessThanXSeconds",5,r):P<10?s.formatDistance("lessThanXSeconds",10,r):P<20?s.formatDistance("lessThanXSeconds",20,r):P<40?s.formatDistance("halfAMinute",0,r):P<60?s.formatDistance("lessThanXMinutes",1,r):s.formatDistance("xMinutes",1,r):f===0?s.formatDistance("lessThanXMinutes",1,r):s.formatDistance("xMinutes",f,r);if(f<45)return s.formatDistance("xMinutes",f,r);if(f<90)return s.formatDistance("aboutXHours",1,r);if(f<ve){const M=Math.round(f/60);return s.formatDistance("aboutXHours",M,r)}else{if(f<a)return s.formatDistance("xDays",1,r);if(f<j){const M=Math.round(f/ve);return s.formatDistance("xDays",M,r)}else if(f<j*2)return F=Math.round(f/j),s.formatDistance("aboutXMonths",F,r)}if(F=yt(h,d),F<12){const M=Math.round(f/j);return s.formatDistance("xMonths",M,r)}else{const M=F%12,Z=Math.trunc(F/12);return M<3?s.formatDistance("aboutXYears",Z,r):M<9?s.formatDistance("overXYears",Z,r):s.formatDistance("almostXYears",Z+1,r)}}function en(e,t){return Zt(e,ut(e),t)}var tn=H({name:"QResponsive",props:Ge,setup(e,{slots:t}){const n=Ze(e);return()=>S("div",{class:"q-responsive"},[S("div",{class:"q-responsive__filler overflow-hidden"},[S("div",{style:n.value})]),S("div",{class:"q-responsive__content absolute-full fit"},W(t.default))])}});const nn=se({name:"ChooseMint",mixins:[windowMixin],props:{rounded:{type:Boolean,default:!1},dense:{type:Boolean,default:!1},title:{type:String,default:Je.global.t("ChooseMint.title")},style:{type:String,default:""},placeholder:{type:String,default:""},showBalances:{type:Boolean,default:!0},requireActiveMint:{type:Boolean,default:!0},modelValue:{type:String,default:null}},emits:["update:modelValue"],data:function(){return{chosenMint:null}},mounted(){this.initializeChosenMint()},watch:{chosenMint:async function(){this.modelValue!==null?this.$emit("update:modelValue",this.chosenMint?.url||""):this.activeMintUrl=this.chosenMint?.url||""},modelValue:{handler(){this.initializeChosenMint()},immediate:!0},activeMintUrl:{handler(){this.modelValue===null&&this.initializeChosenMint()}}},computed:{...be(B,["activeMintUrl","activeProofs","mints","activeUnit"]),...we(B,["activeMintUrl"]),getBalance:function(){return this.activeProofs.flat().reduce((e,t)=>e+=t.amount,0)}},methods:{...ke(B,["activateMintUrl"]),initializeChosenMint(){const e=this.modelValue!==null?this.modelValue:this.activeMintUrl;if(e){const t=this.mints.find(n=>n.url===e);if(t){const n=new ce(t);this.chosenMint={url:e,nickname:n.mint.nickname||n.mint.info?.name,shorturl:le(e),errored:n.mint.errored}}}},chooseMintOptions:function(){let e=[];for(const[t,n]of Object.entries(this.mints)){const o=n.keysets.map(i=>i.unit),s=[...new Set(o)],a=new ce(n);e.push({nickname:a.mint.nickname||a.mint.info?.name,url:a.mint.url,shorturl:le(n.url),balances:a.allBalances,errored:a.mint.errored,units:s})}return e}}}),on={class:"q-pb-md"},sn={key:0,class:"row q-mb-none"},an={class:"col-12"},rn={class:"text-caption"},ln={key:1,class:"row q-mt-xs q-mb-none"},cn={class:"col-12 cursor-pointer"},dn={key:0},un={key:0,class:"error-badge"},hn={class:"row items-center"};function mn(e,t,n,o,s,a){return g(),T("div",on,[e.title.length?(g(),T("div",sn,[_("div",an,[_("span",rn,k(e.title),1)])])):N("",!0),e.activeMintUrl||!e.requireActiveMint?(g(),T("div",ln,[_("div",cn,[l(He,{outlined:"",class:"q-px-none",color:"white",modelValue:e.chosenMint,"onUpdate:modelValue":t[0]||(t[0]=i=>e.chosenMint=i),options:e.chooseMintOptions(),"option-value":"url","option-label":"nickname",rounded:e.rounded,style:re(e.style),dense:e.dense,placeholder:e.placeholder},$e({option:c(i=>[l(_e,Ce(qe(i.itemProps)),{default:c(()=>[l(Y,null,{default:c(()=>[l($,{class:"text-body1 q-pt-xs",style:re(e.activeMintUrl===i.opt.url?"font-weight: bold":"")},{default:c(()=>[b(k(i.opt.nickname||i.opt.shorturl),1)]),_:2},1032,["style"]),l($,{class:"text-caption q-pb-xs",style:{"font-family":"monospace","font-size":"11px"}},{default:c(()=>[b(k(i.opt.url),1)]),_:2},1024),e.showBalances?(g(),T("div",dn,[(g(!0),T(Pe,null,Se(i.opt.units,r=>(g(),I(K,{key:r,color:i.opt.url===e.activeMintUrl?"primary":"grey",label:e.formatCurrency(i.opt.balances[r],r),class:"q-mr-xs q-mb-xs"},null,8,["color","label"]))),128)),i.opt.errored?(g(),T("div",un,[l(K,{color:"red",class:"q-mr-xs q-mt-sm text-weight-bold"},{default:c(()=>[b(k(e.$t("ChooseMint.badge_option_mint_error_text"))+" ",1),l(R,{name:"error",class:"q-ml-xs"})]),_:1})])):N("",!0)])):N("",!0)]),_:2},1024)]),_:2},1040),l(Ve)]),prepend:c(()=>[l(R,{name:"account_balance",size:"1.2rem",color:"grey",class:"q-mr-none q-mb-none"})]),_:2},[e.showBalances?{name:"append",fn:c(()=>[_("div",hn,[e.chosenMint?.errored?(g(),I(K,{key:0,color:"red",class:"q-mr-xs text-weight-bold"},{default:c(()=>[b(k(e.$t("ChooseMint.badge_mint_error_text"))+" ",1),l(R,{name:"error",class:"q-ml-xs"})]),_:1})):N("",!0),l(K,{color:"primary",label:e.formatCurrency(e.getBalance,e.activeUnit),class:"q-ma-xs q-pa-sm text-weight-bold"},null,8,["label"])])]),key:"0"}:void 0]),1032,["modelValue","options","rounded","style","dense","placeholder"])])])):N("",!0)])}var to=ae(nn,[["render",mn]]);const fn=se({name:"P2PKDialog",mixins:[windowMixin],components:{VueQrcode:ot},data:function(){return{}},computed:{...be(ee,["p2pkKeys","showP2PKData","showLastKey"]),...we(ee,["showP2PKDialog"])},methods:{...ke(ee,["generateKeypair","showKeyDetails"]),newKeys:function(){this.generateKeypair(),this.showLastKey()}}}),gn={class:"text-center q-mb-md q-mt-none q-pt-none"},pn={class:"row justify-center"},vn={class:"row justify-center"},yn={key:0,class:"row justify-center q-pt-sm"},bn={key:1,class:"row justify-center q-pt-sm"},wn={class:"row q-mt-lg"};function kn(e,t,n,o,s,a){const i=Ae("vue-qrcode");return g(),I(tt,{modelValue:e.showP2PKDialog,"onUpdate:modelValue":t[1]||(t[1]=r=>e.showP2PKDialog=r),position:"top","backdrop-filter":"blur(2px) brightness(60%)"},{default:c(()=>[e.showP2PKData.publicKey?(g(),I(et,{key:0,class:"q-px-lg q-pt-md q-pb-md qcard"},{default:c(()=>[_("div",gn,[l(tn,{ratio:1,class:"q-mx-md q-mt-none q-pt-none"},{default:c(()=>[l(i,{value:e.showP2PKData.publicKey,options:{width:340},class:"rounded-borders"},null,8,["value"])]),_:1}),_("div",pn,[l(rt,{class:"q-pa-sm"},{default:c(()=>[_("div",vn,[l($,{overline:"",class:"q-mb-sm q-pt-md text-white"},{default:c(()=>[b(k(e.$t("P2PKDialog.p2pk.caption")),1)]),_:1})]),e.showP2PKData.used?(g(),T("div",yn,[l($,{caption:"",class:"text-weight-bold text-warning",style:{"font-size":"14px"}},{default:c(()=>[b(k(e.$t("P2PKDialog.p2pk.used_warning_text")),1)]),_:1})])):(g(),T("div",bn,[l($,{caption:"",class:"text-weight-light text-white",style:{"font-size":"14px"}},{default:c(()=>[b(k(e.$t("P2PKDialog.p2pk.description")),1)]),_:1})]))]),_:1})]),l(V,{class:"q-mx-xs q-px-md q-mt-md",size:"md",color:"primary",flat:"",rounded:"",dense:"",onClick:e.newKeys},{default:c(()=>[l(R,{name:"refresh",class:"q-pr-sm",size:"xs"}),b(" "+k(e.$t("P2PKDialog.actions.new_key.label")),1)]),_:1},8,["onClick"]),_("div",wn,[l(V,{class:"q-mx-xs",size:"md",flat:"",onClick:t[0]||(t[0]=r=>e.copyText(e.showP2PKData.publicKey))},{default:c(()=>[b(k(e.$t("P2PKDialog.actions.copy.label")),1)]),_:1}),Re((g(),I(V,{flat:"",color:"grey",class:"q-ml-auto"},{default:c(()=>[b(k(e.$t("P2PKDialog.actions.close.label")),1)]),_:1})),[[nt]])])])]),_:1})):N("",!0)]),_:1},8,["modelValue"])}var no=ae(fn,[["render",kn]]),oo=H({name:"QBanner",props:{...st,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(e,{slots:t}){const{proxy:{$q:n}}=Ie(),o=at(e,n),s=L(()=>"q-banner row items-center"+(e.dense===!0?" q-banner--dense":"")+(o.value===!0?" q-banner--dark q-dark":"")+(e.rounded===!0?" rounded-borders":"")),a=L(()=>`q-banner__actions row items-center justify-end col-${e.inlineActions===!0?"auto":"all"}`);return()=>{const i=[S("div",{class:"q-banner__avatar col-auto row items-center self-start"},W(t.avatar)),S("div",{class:"q-banner__content col text-body2"},W(t.default))],r=W(t.action);return r!==void 0&&i.push(S("div",{class:a.value},r)),S("div",{class:s.value+(e.inlineActions===!1&&r!==void 0?" q-banner--top-padding":""),role:"alert"},i)}}});const Fe=E.getPlatform()==="ios"&&typeof window.webkit?.messageHandlers?.bluetoothBridge<"u";console.log("\u{1F535} [BluetoothEcash] Platform:",E.getPlatform(),"Native iOS:",Fe);const Pn={startService:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e()};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"startBluetoothService",callbackId:n})}),stopService:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e()};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"stopBluetoothService",callbackId:n})}),sendToken:async e=>new Promise((t,n)=>{const o=Math.random().toString(36),s=a=>{window.removeEventListener(`bluetooth_callback_${o}`,s),t(a.detail)};window.addEventListener(`bluetooth_callback_${o}`,s,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"sendToken",callbackId:o,options:e})}),getAvailablePeers:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"getAvailablePeers",callbackId:n})}),getUnclaimedTokens:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"getUnclaimedTokens",callbackId:n})}),markTokenClaimed:async e=>new Promise((t,n)=>{const o=Math.random().toString(36),s=a=>{window.removeEventListener(`bluetooth_callback_${o}`,s),t()};window.addEventListener(`bluetooth_callback_${o}`,s,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"markTokenClaimed",callbackId:o,messageId:e.messageId})}),setNickname:async e=>new Promise((t,n)=>{const o=Math.random().toString(36),s=a=>{window.removeEventListener(`bluetooth_callback_${o}`,s),t(a.detail)};window.addEventListener(`bluetooth_callback_${o}`,s,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"setNickname",callbackId:o,nickname:e.nickname})}),getNickname:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"getNickname",callbackId:n})}),isBluetoothEnabled:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"isBluetoothEnabled",callbackId:n})}),requestBluetoothEnable:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"requestBluetoothEnable",callbackId:n})}),requestPermissions:async()=>new Promise((e,t)=>{const n=Math.random().toString(36),o=s=>{window.removeEventListener(`bluetooth_callback_${n}`,o),e(s.detail)};window.addEventListener(`bluetooth_callback_${n}`,o,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"requestPermissions",callbackId:n})}),sendTextMessage:async e=>new Promise((t,n)=>{const o=Math.random().toString(36),s=a=>{window.removeEventListener(`bluetooth_callback_${o}`,s),t()};window.addEventListener(`bluetooth_callback_${o}`,s,{once:!0}),window.webkit.messageHandlers.bluetoothBridge.postMessage({action:"sendTextMessage",callbackId:o,peerID:e.peerID,message:e.message})}),addListener:async(e,t)=>{const o={ecashReceived:"bluetooth_ecashReceived",peerDiscovered:"bluetooth_peerDiscovered",peerLost:"bluetooth_peerLost",tokenSent:"bluetooth_tokenSent",tokenSendFailed:"bluetooth_tokenSendFailed",tokenDelivered:"bluetooth_tokenDelivered",favoriteNotificationReceived:"bluetooth_favoriteNotificationReceived",favoriteRequestReceived:"bluetooth_favoriteRequestReceived",favoriteAcceptedReceived:"bluetooth_favoriteAcceptedReceived"}[e]||e,s=a=>{t(a.detail)};return window.addEventListener(o,s),{remove:()=>{window.removeEventListener(o,s)}}}},m=Fe?Pn:Ke("BluetoothEcash",{web:()=>({startService:async()=>{console.warn("Bluetooth mesh not available in web browser")},stopService:async()=>{},setNickname:async()=>({nickname:""}),getNickname:async()=>({nickname:""}),isBluetoothEnabled:async()=>({enabled:!1}),requestBluetoothEnable:async()=>({requested:!1}),sendToken:async()=>({messageId:""}),sendTextMessage:async()=>{},getAvailablePeers:async()=>({peers:[]}),getUnclaimedTokens:async()=>({tokens:[]}),markTokenClaimed:async()=>{},requestPermissions:async()=>({granted:!1}),addListener:async()=>({remove:()=>{}})})});console.log("\u{1F535} [BluetoothEcash] Plugin registered successfully");const z="f47b5e2d-4a9e-4c5a-9b3f-8e1d2c3a4b5c",Sn="a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d";class Me{devices=new Map;myNickname=De();isScanning=!1;onTokenReceived;onPeerDiscovered;static isAvailable(){return typeof navigator<"u"&&"bluetooth"in navigator}initialize(t){this.myNickname=t}async requestDevice(){try{if(console.log("\u{1F50D} Starting Web Bluetooth device discovery..."),console.log("\u{1F4CD} Current URL:",window.location.href),console.log("\u{1F512} HTTPS:",window.location.protocol==="https:"),!navigator.bluetooth)throw new Error("Web Bluetooth not supported in this browser");let t;try{console.log("\u{1F3AF} Attempting to find devices with Bitpoints service..."),t=await navigator.bluetooth.requestDevice({filters:[{services:[z]}],optionalServices:[z]}),console.log("\u2705 Found device with Bitpoints service:",t.name)}catch(s){console.log("\u26A0\uFE0F No devices with Bitpoints service found, trying generic BLE devices..."),console.log("Service error:",s),console.log("\u{1F50D} Requesting all BLE devices..."),t=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[z]}),console.log("\u2705 Found generic BLE device:",t.name)}let n=t.name||"Unknown Device";t.name&&t.name.startsWith("BP:")?n=t.name.substring(3):t.name&&(n=t.name);const o={id:t.id,nickname:n,device:t,lastSeen:Date.now()};this.devices.set(t.id,o);try{await this.connectToPeer(o)}catch(s){console.warn("Could not connect to device with Bitpoints service, but device is available:",s)}return this.onPeerDiscovered&&this.onPeerDiscovered(o),o}catch(t){return console.error("Failed to request Bluetooth device:",t),(t.name==="NotFoundError"||t.name==="SecurityError")&&console.log("User cancelled device selection or permission denied"),null}}async connectToPeer(t){try{if(!t.device.gatt){console.error("Device has no GATT server");return}const n=await t.device.gatt.connect();t.server=n;const s=await(await n.getPrimaryService(z)).getCharacteristic(Sn);t.characteristic=s,s.addEventListener("characteristicvaluechanged",a=>{const r=a.target.value;r&&this.handleReceivedData(r,t)}),await s.startNotifications(),console.log(`Connected to peer: ${t.nickname} (${t.id})`)}catch(n){console.error("Failed to connect to peer:",n)}}async sendToken(t,n){const o=this.devices.get(n);if(!o||!o.characteristic)return console.error("Peer not connected:",n),!1;try{const s={type:"ECASH_TOKEN",token:t,sender:this.myNickname,timestamp:Date.now()},a=new TextEncoder().encode(JSON.stringify(s));return await o.characteristic.writeValue(a),console.log(`Sent token to ${o.nickname} via Web Bluetooth`),!0}catch(s){return console.error("Failed to send token:",s),!1}}handleReceivedData(t,n){try{const s=new TextDecoder().decode(t),a=JSON.parse(s);a.type==="ECASH_TOKEN"&&a.token&&(console.log(`Received token from ${n.nickname} via Web Bluetooth`),this.onTokenReceived&&this.onTokenReceived(a.token,n))}catch(o){console.error("Failed to parse received data:",o)}}getPeers(){return Array.from(this.devices.values())}async disconnect(t){const n=this.devices.get(t);n&&n.server&&(n.server.disconnect(),this.devices.delete(t))}disconnectAll(){for(const t of this.devices.values())t.server&&t.server.disconnect();this.devices.clear()}setOnTokenReceived(t){this.onTokenReceived=t}setOnPeerDiscovered(t){this.onPeerDiscovered=t}}const C=new Me,J=G("favorites",{state:()=>({favorites:y("bitpoints-favorites",{}),pendingRequests:y("bitpoints-pending-favorites",{}),peerIdIndex:y("bitpoints-peerid-index",{})}),getters:{mutualFavorites:e=>Object.values(e.favorites).filter(t=>t.isFavorite&&t.theyFavoritedUs),myFavorites:e=>Object.values(e.favorites).filter(t=>t.isFavorite),favoritesWithNostr:e=>Object.values(e.favorites).filter(t=>t.isFavorite&&t.peerNostrNpub!==null),mutualCount(){return this.mutualFavorites.length},pendingRequestsList:e=>Object.values(e.pendingRequests),pendingCount(){return this.pendingRequestsList.length}},actions:{addFavorite(e,t,n=null){console.log(`\u2B50\uFE0F Adding favorite: ${t} (${e.substring(0,16)}...)`);const o=this.favorites[e],s={peerNoisePublicKey:e,peerNostrNpub:n??o?.peerNostrNpub??null,peerNickname:t,isFavorite:!0,theyFavoritedUs:o?.theyFavoritedUs??!1,favoritedAt:o?.favoritedAt??new Date,lastUpdated:new Date};if(s.isFavorite&&s.theyFavoritedUs&&console.log(`\u{1F495} Mutual favorite relationship established with ${t}!`),this.favorites[e]=s,s.peerNostrNpub){const a=e.substring(0,16).toLowerCase();this.updateNostrPublicKeyForPeerID(a,s.peerNostrNpub)}},removeFavorite(e){const t=this.favorites[e];!t||(console.log(`\u2B50\uFE0F Removing favorite: ${t.peerNickname}`),t.theyFavoritedUs?this.favorites[e]={...t,isFavorite:!1,lastUpdated:new Date}:delete this.favorites[e])},updatePeerFavoritedUs(e,t,n,o){const s=this.favorites[e],a=n??s?.peerNickname??"Unknown";console.log(`\u{1F4E8} Received favorite notification: ${a} ${t?"favorited":"unfavorited"} us`);const i={peerNoisePublicKey:e,peerNostrNpub:o??s?.peerNostrNpub??null,peerNickname:a,isFavorite:s?.isFavorite??!1,theyFavoritedUs:t,favoritedAt:s?.favoritedAt??new Date,lastUpdated:new Date};!i.isFavorite&&!i.theyFavoritedUs?delete this.favorites[e]:(this.favorites[e]=i,i.isFavorite&&i.theyFavoritedUs&&console.log(`\u{1F495} Mutual favorite relationship established with ${a}!`))},isFavorite(e){return this.favorites[e]?.isFavorite??!1},isMutualFavorite(e){const t=this.favorites[e];return(t?.isFavorite&&t?.theyFavoritedUs)??!1},getFavoriteStatus(e){return this.favorites[e]??null},updateNostrNpub(e,t){const n=this.favorites[e];if(n){this.favorites[e]={...n,peerNostrNpub:t,lastUpdated:new Date},console.log(`Updated Nostr npub for ${n.peerNickname}`);const o=e.substring(0,16).toLowerCase();this.updateNostrPublicKeyForPeerID(o,t)}},updateNostrPublicKeyForPeerID(e,t){const n=e.toLowerCase();n.length===16&&/^[0-9a-f]+$/.test(n)?(this.peerIdIndex[n]=t,console.log(`Indexed npub for peerID ${n.substring(0,8)}\u2026`)):console.warn(`updateNostrPublicKeyForPeerID called with non-16hex peerID: ${e}`)},findNostrPubkeyForPeerID(e){return this.peerIdIndex[e.toLowerCase()]||null},findPeerIDForNostrPubkey(e){const t=Object.entries(this.peerIdIndex).find(([o,s])=>s.toLowerCase()===e.toLowerCase());if(t)return t[0];const n=Object.values(this.favorites).find(o=>o.peerNostrNpub?.toLowerCase()===e.toLowerCase());if(n){const o=n.peerNoisePublicKey;if(o.length>=16)return o.substring(0,16).toLowerCase()}return null},clearAll(){console.log("\u{1F9F9} Clearing all favorites"),this.favorites={},this.peerIdIndex={}},addPendingRequest(e,t,n){console.log(`\u{1F4EC} [STORE] Adding pending request: ${t} (${e.substring(0,16)}...)`),console.log(`\u{1F4EC} [STORE] npub: ${n.substring(0,16)}...`);const o={peerNoisePublicKey:e,peerNickname:t,peerNostrNpub:n,receivedAt:new Date};this.pendingRequests[e]=o,console.log("\u{1F4EC} [STORE] Pending request saved. Total count:",Object.keys(this.pendingRequests).length),console.log("\u{1F4EC} [STORE] Pending requests:",this.pendingRequests)},removePendingRequest(e){console.log(`\u{1F5D1}\uFE0F Removing pending request from: ${e.substring(0,16)}...`),delete this.pendingRequests[e]},acceptPendingRequest(e){const t=this.pendingRequests[e];return t?(console.log(`\u2705 Accepting favorite request from: ${t.peerNickname}`),this.addFavorite(t.peerNoisePublicKey,t.peerNickname,t.peerNostrNpub),this.updatePeerFavoritedUs(t.peerNoisePublicKey,!0),this.removePendingRequest(e),t):(console.warn(`\u26A0\uFE0F No pending request found for ${e}`),null)}}}),_n=G("bluetooth",{state:()=>({isActive:!1,isInitialized:!1,nearbyPeers:[],unclaimedTokens:y("bluetooth-unclaimed-tokens",[]),contacts:y("bluetooth-contacts",[]),pendingMessages:[],nickname:y("bluetooth-nickname",De()),alwaysOnEnabled:y("bluetooth-always-on",!0),alwaysOnActive:!1}),getters:{isDesktop:()=>!E.isNativePlatform(),isWebBluetoothAvailable:()=>{try{return Me.isAvailable()}catch(e){return console.error("Error checking Web Bluetooth availability:",e),!1}},isBluetoothAvailable(){return E.isNativePlatform()||this.isWebBluetoothAvailable},sortedPeers:e=>[...e.nearbyPeers].sort((t,n)=>n.lastSeen-t.lastSeen),directPeers:e=>e.nearbyPeers.filter(t=>t.isDirect),knownPeers:e=>e.nearbyPeers.filter(t=>t.nostrNpub&&t.nostrNpub.length>0),unclaimedCount:e=>e.unclaimedTokens.filter(t=>!t.claimed).length,unclaimedValue:e=>e.unclaimedTokens.filter(t=>!t.claimed&&t.unit==="sat").reduce((t,n)=>t+n.amount,0)},actions:{async initialize(){if(!this.isInitialized)try{if(this.isDesktop){if(!this.isWebBluetoothAvailable){console.log("Web Bluetooth not available. Use Chrome or Edge browser.");return}C.initialize(this.nickname),C.setOnPeerDiscovered(e=>{console.log("Web Bluetooth: Peer discovered",e),this.handlePeerDiscovered({peerID:e.id,nickname:e.nickname,lastSeen:e.lastSeen,isDirect:!0,nostrNpub:"",isConnected:!0})}),C.setOnTokenReceived((e,t)=>{console.log("Web Bluetooth: Token received",e),this.handleEcashReceived({id:Date.now().toString(),sender:t.nickname,senderPeerID:t.id,timestamp:Date.now(),amount:0,unit:"sat",cashuToken:e,mint:"",memo:"",claimed:!1,deliveryStatus:"delivered"})}),this.isInitialized=!0,console.log("Web Bluetooth service initialized");return}await m.addListener("ecashReceived",e=>{console.log("Ecash received via Bluetooth:",e),this.handleEcashReceived(e)}),await m.addListener("peerDiscovered",e=>{console.log("Peer discovered:",e),this.handlePeerDiscovered(e)}),await m.addListener("peerLost",e=>{console.log("Peer lost:",e),this.handlePeerLost(e.peerID)}),await m.addListener("tokenSent",e=>{console.log("Token sent:",e),this.handleTokenSent(e.messageId)}),await m.addListener("tokenDelivered",e=>{console.log("Token delivered:",e),this.handleTokenDelivered(e.messageId,e.peerID)}),await m.addListener("favoriteNotificationReceived",e=>{console.log("\u2B50\uFE0F Favorite notification received:",e),this.handleFavoriteNotification(e.peerID,e.npub,e.isFavorite)}),await m.addListener("favoriteRequestReceived",e=>{console.log("\u{1F4EC} [LISTENER] Favorite request received:",e),console.log("\u{1F4EC} [LISTENER] peerID:",e.peerID),console.log("\u{1F4EC} [LISTENER] nickname:",e.nickname),console.log("\u{1F4EC} [LISTENER] npub:",e.npub?.substring(0,16)),this.handleFavoriteRequest(e.peerID,e.nickname,e.npub)}),await m.addListener("favoriteAcceptedReceived",e=>{console.log("\u2705 Favorite accepted received:",e),this.handleFavoriteAccepted(e.peerID,e.npub)}),this.isInitialized=!0,console.log("Bluetooth ecash service initialized"),this.debugTokenState(),this.unclaimedTokens.length>50?(console.log(`\u{1F9F9} Too many tokens (${this.unclaimedTokens.length}), clearing localStorage`),this.clearAllUnclaimedTokens()):this.cleanupUnclaimedTokensOnStartup().catch(console.error)}catch(e){console.error("Failed to initialize Bluetooth service:",e)}},async startService(){try{if(this.isDesktop){if(console.log("\u{1F5A5}\uFE0F Desktop PWA detected, using Web Bluetooth..."),!this.isWebBluetoothAvailable)return console.error("\u274C Web Bluetooth not available"),p("Web Bluetooth not supported. Please use Chrome or Edge browser."),!1;console.log("\u2705 Web Bluetooth available, starting service..."),console.log("\u{1F517} Current URL:",window.location.href),console.log("\u{1F512} HTTPS enabled:",window.location.protocol==="https:"),console.log("\u{1F3AF} Requesting Bluetooth device...");const t=await C.requestDevice();return t?(console.log("\u{1F389} Device connected successfully:",t),this.isActive=!0,w(`Connected to ${t.nickname}!`),console.log("\u2705 Web Bluetooth service started"),!0):(console.log("\u26A0\uFE0F User cancelled device selection or no device available"),!1)}const{granted:e}=await m.requestPermissions();return e?(console.log(`Setting Bluetooth nickname: ${this.nickname}`),await m.setNickname({nickname:this.nickname}),await m.startService(),this.isActive=!0,console.log(`Bluetooth mesh service started with nickname: ${this.nickname}`),this.startPeerPolling(),!0):(q("Bluetooth permissions required for nearby payments"),!1)}catch(e){return console.error("Failed to start Bluetooth service:",e),p("Failed to start Bluetooth service"),!1}},async stopService(){try{if(this.isDesktop){C.disconnectAll(),this.isActive=!1,this.nearbyPeers=[],console.log("Web Bluetooth service stopped");return}await m.stopService(),this.isActive=!1,this.nearbyPeers=[],console.log("Bluetooth mesh service stopped")}catch(e){console.error("Failed to stop Bluetooth service:",e)}},async updateNickname(e){if(e.length<3||e.length>32)throw new Error("Nickname must be 3-32 characters");const t=this.isActive;this.nickname=e,this.isDesktop?C.initialize(e):await m.setNickname({nickname:e}),t&&(await this.stopService(),await this.startService(),console.log(`Bluetooth nickname updated to: ${e}`))},async sendToken(e){console.log("\u{1F535} [STORE] sendToken called with:",e),u.send(`Initiating send: ${e.amount} ${e.unit} to ${e.peerID||"broadcast"}`,{amount:e.amount,unit:e.unit,peerID:e.peerID,mint:e.mint,memo:e.memo,tokenLength:e.token?.length||0});try{if(this.isDesktop){if(!e.peerID)return u.error("Web Bluetooth requires specific peer selection"),p("Web Bluetooth requires specific peer selection"),null;if(u.send("Using Web Bluetooth for send",{peerID:e.peerID}),console.log("\u{1F535} [WEB] Sending token via Web Bluetooth..."),await C.sendToken(e.token,e.peerID)){const s=Date.now().toString();return this.pendingMessages.push(s),u.send("Web Bluetooth send successful",{messageId:s}),console.log("\u{1F535} [WEB] Success, messageId:",s),s}else return u.error("Web Bluetooth send failed"),p("Failed to send token via Web Bluetooth"),null}u.send("Using native Bluetooth for send",{platform:"native"}),console.log("\u{1F535} [STORE] Calling BluetoothEcash.sendToken...");const t=await m.sendToken(e);console.log("\u{1F535} [STORE] Native returned:",t);const{messageId:n}=t;return this.pendingMessages.push(n),u.send("Native send successful",{messageId:n,result:t}),console.log("\u{1F535} [STORE] Success, returning messageId:",n),n}catch(t){return u.error("Send failed with error",{error:t?.message||t?.toString(),stack:t?.stack}),console.error("\u{1F535} [STORE ERROR]:",t),p("Failed to send token via Bluetooth"),null}},async sendTextMessage(e,t){try{return this.isActive?this.isDesktop?(console.warn("Web Bluetooth text messaging not supported yet"),!1):(await m.sendTextMessage({peerID:e,message:t}),console.log(`\u{1F4E4} Sent text message to ${e}: ${t.substring(0,30)}...`),!0):(console.warn("Bluetooth not active, cannot send text message"),!1)}catch(n){return console.error("Failed to send text message:",n),!1}},async claimToken(e){u.claim("Starting token claim process",{messageId:e});try{const t=this.unclaimedTokens.find(a=>a.id===e);if(!t)throw u.error("Token not found in unclaimed list",{messageId:e}),new Error("Token not found");u.claim("Token found, preparing for claim",{messageId:e,amount:t.amount,unit:t.unit,sender:t.sender,tokenLength:t.cashuToken?.length||0});const n=A(),o=de();if(o.receiveData.tokensBase64=t.cashuToken,u.claim("Calling receiveIfDecodes",{messageId:e}),await o.receiveIfDecodes()){u.claim("Token decode and validation successful",{messageId:e}),await m.markTokenClaimed({messageId:e});const a=this.unclaimedTokens.findIndex(i=>i.id===e);return a!==-1&&(this.unclaimedTokens[a]={...t,claimed:!0}),this.addContact(t.sender,t.senderPeerID),u.claim("\u2705 Token claimed successfully",{messageId:e,amount:t.amount,unit:t.unit,sender:t.sender}),w(`Claimed ${t.amount} ${t.unit} from ${t.sender.substring(0,16)}...`),!0}else throw u.error("Token decode/validation failed",{messageId:e}),new Error("Failed to redeem token with mint")}catch(t){u.error("Claim failed with error",{messageId:e,error:t?.message||t?.toString(),stack:t?.stack}),console.error("Failed to claim token:",t);const n=t?.message||t?.toString()||"";if(n.includes("Token already spent")||n.includes("already spent")){u.claim("Token already spent, removing from unclaimed list",{messageId:e}),console.log(`Token ${e} already spent, removing from unclaimed list`);const o=this.unclaimedTokens.findIndex(s=>s.id===e);return o!==-1&&(this.unclaimedTokens.splice(o,1),console.log(`Removed already spent token ${e} from unclaimed list`)),!0}return u.error("Claim failed, showing error notification",{messageId:e,error:n}),p("Failed to claim token"),!1}},async autoClaimTokens(){if(!navigator.onLine){u.claim("Offline - skipping auto-claim",{online:!1}),console.log("Offline - skipping auto-claim");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);u.claim(`Auto-claiming ${e.length} tokens`,{count:e.length,online:!0}),console.log(`Auto-claiming ${e.length} tokens`);for(const t of e)u.claim(`Auto-claiming token ${t.id}`,{messageId:t.id,amount:t.amount,unit:t.unit}),await this.claimToken(t.id),await new Promise(n=>setTimeout(n,500))},async autoClaimTokensSilently(){if(console.log("\u{1F527} Starting autoClaimTokensSilently..."),!navigator.onLine){console.log("Offline - skipping silent auto-claim");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);console.log(`Silently claiming ${e.length} tokens`);for(const t of e){try{await this.claimTokenSilently(t.id)}catch(n){console.log(`Failed to claim token ${t.id}:`,n)}await new Promise(n=>setTimeout(n,200))}console.log(`Silent claim completed. Remaining unclaimed tokens: ${this.unclaimedTokens.filter(t=>!t.claimed).length}`)},async cleanupUnclaimedTokensOnStartup(){if(console.log("\u{1F527} Starting cleanupUnclaimedTokensOnStartup..."),!navigator.onLine){console.log("Offline - skipping startup cleanup");return}const e=this.unclaimedTokens.filter(t=>!t.claimed);if(console.log(`Found ${e.length} unclaimed tokens`),e.length===0){console.log("No unclaimed tokens to clean up");return}console.log(`Cleaning up ${e.length} unclaimed tokens on startup...`);for(const t of e){try{await this.claimTokenSilently(t.id)&&console.log(`Successfully claimed token ${t.id}`)}catch(n){console.log(`Failed to claim token ${t.id}:`,n)}await new Promise(n=>setTimeout(n,200))}console.log(`Startup cleanup completed. Remaining unclaimed tokens: ${this.unclaimedTokens.filter(t=>!t.claimed).length}`)},clearAllUnclaimedTokens(){const e=this.unclaimedTokens.length;this.unclaimedTokens=[],localStorage.removeItem("bluetooth-unclaimed-tokens"),console.log(`\u{1F9F9} Force cleared ${e} unclaimed tokens from memory and localStorage`),w(`Cleared ${e} unclaimed tokens`)},debugTokenState(){console.log(`\u{1F50D} Debug: Total unclaimed tokens: ${this.unclaimedTokens.length}`),console.log(`\u{1F50D} Debug: Claimed tokens: ${this.unclaimedTokens.filter(e=>e.claimed).length}`),console.log(`\u{1F50D} Debug: Unclaimed tokens: ${this.unclaimedTokens.filter(e=>!e.claimed).length}`),this.unclaimedTokens.forEach((e,t)=>{console.log(`\u{1F50D} Token ${t}: ID=${e.id}, Amount=${e.amount}, Claimed=${e.claimed}`)})},async claimTokenSilently(e){try{const t=this.unclaimedTokens.find(a=>a.id===e);if(!t)return!1;const n=A(),o=de();if(o.receiveData.tokensBase64=t.cashuToken,await o.receiveIfDecodes()){await m.markTokenClaimed({messageId:e});const a=this.unclaimedTokens.findIndex(i=>i.id===e);return a!==-1&&(this.unclaimedTokens[a]={...t,claimed:!0}),this.addContact(t.sender,t.senderPeerID),!0}else return!1}catch(t){const n=t?.message||t?.toString()||"";if(n.includes("Token already spent")||n.includes("already spent")){console.log(`Token ${e} already spent, removing from unclaimed list`);const o=this.unclaimedTokens.findIndex(s=>s.id===e);return o!==-1&&(this.unclaimedTokens.splice(o,1),console.log(`Removed already spent token ${e} from unclaimed list`)),!0}return!1}},handleEcashReceived(e){u.receive(`Token received from peer ${e.senderPeerID}`,{messageId:e.id,sender:e.sender,senderPeerID:e.senderPeerID,amount:e.amount,unit:e.unit,memo:e.memo,tokenLength:e.cashuToken?.length||0,tokenPreview:e.cashuToken?.substring(0,50)+"..."||"N/A"}),this.unclaimedTokens.find(n=>n.id===e.id)?u.receive("Token already exists in unclaimed list",{messageId:e.id}):(this.unclaimedTokens.push(e),w(`Received ${e.amount} ${e.unit} via Bluetooth!`,e.memo||"From nearby peer"),navigator.onLine?(u.claim("Auto-claiming received token",{messageId:e.id,online:!0}),this.claimToken(e.id)):u.claim("Token received offline, will claim when online",{messageId:e.id,online:!1}))},handlePeerDiscovered(e){if(!this.nearbyPeers.find(n=>n.peerID===e.peerID))this.nearbyPeers.push(e),u.peer("New peer discovered",{peerID:e.peerID,nickname:e.nickname||"unnamed",isDirect:e.isDirect,isConnected:e.isConnected}),console.log(`New peer discovered: ${e.peerID} (${e.nickname||"unnamed"})`);else{const n=this.nearbyPeers.findIndex(o=>o.peerID===e.peerID);this.nearbyPeers[n]=e,u.peer("Peer info updated",{peerID:e.peerID,nickname:e.nickname||"unnamed"})}},handlePeerLost(e){const t=this.nearbyPeers.findIndex(n=>n.peerID===e);t!==-1&&(this.nearbyPeers.splice(t,1),u.peer("Peer lost",{peerID:e}),console.log(`Peer lost: ${e}`))},handleTokenSent(e){const t=this.pendingMessages.indexOf(e);t!==-1&&this.pendingMessages.splice(t,1)},handleTokenDelivered(e,t){console.log(`Token ${e} delivered to ${t}`)},handleFavoriteNotification(e,t,n){console.log(`\u2B50\uFE0F ${n?"FAVORITED":"UNFAVORITED"} by ${e} with npub: ${t.substring(0,16)}...`);const o=J();o.updateNostrNpub(e,t),o.updateNostrPublicKeyForPeerID(e,t),n?o.updatePeerFavoritedUs(e,!0):o.updatePeerFavoritedUs(e,!1);const a=this.nearbyPeers.find(i=>i.peerID===e)?.nickname||e.substring(0,8);n&&(o.isMutualFavorite(e)?w(`\u{1F495} Mutual favorite with ${a}! You can now message via Nostr.`):w(`\u2B50\uFE0F ${a} added you as favorite. Favorite back for Nostr messaging!`))},handleFavoriteRequest(e,t,n){console.log("\u{1F4EC} [HANDLER] handleFavoriteRequest called"),console.log(`\u{1F4EC} Favorite request from ${t} (${e}) with npub: ${n.substring(0,16)}...`);const o=J();console.log("\u{1F4EC} [HANDLER] Adding pending request to store..."),o.addPendingRequest(e,t,n),console.log("\u{1F4EC} [HANDLER] Pending request added. Count:",o.pendingCount),console.log("\u{1F4EC} [HANDLER] Showing notification..."),w(`\u{1F4EC} ${t} wants to be your favorite!`,{timeout:5e3,actions:[{label:"View",color:"white",handler:()=>{console.log("\u{1F4EC} [NOTIFICATION] View action clicked")}}]})},handleFavoriteAccepted(e,t){console.log(`\u2705 Favorite accepted by ${e} with npub: ${t.substring(0,16)}...`);const n=J();if(n.favorites[e])console.log(`\u2705 Updating existing favorite npub for ${e}`),n.updateNostrNpub(e,t),n.updateNostrPublicKeyForPeerID(e,t);else{const a=this.nearbyPeers.find(i=>i.peerID===e);console.log(`\u2705 Creating favorite for ${e} before updating npub`),n.addFavorite(e,a?.nickname||"Unknown",t)}n.updatePeerFavoritedUs(e,!0);const s=this.nearbyPeers.find(a=>a.peerID===e)?.nickname||e.substring(0,8);w(`\u{1F495} ${s} accepted your favorite request! You can now message via Nostr.`)},async startPeerPolling(){if(!this.isActive)return;const e=async()=>{if(!!this.isActive)try{const{peers:t}=await m.getAvailablePeers();this.nearbyPeers=t,setTimeout(e,5e3)}catch(t){console.error("Failed to poll peers:",t),setTimeout(e,1e4)}};e()},addContact(e,t){if(!this.contacts.find(o=>o.npub===e))this.contacts.push({npub:e,peerID:t,addedAt:Date.now(),lastInteraction:Date.now(),nickname:""}),console.log(`Added contact: ${e}`),navigator.onLine&&this.syncContactsToNostr();else{const o=this.contacts.findIndex(s=>s.npub===e);this.contacts[o].lastInteraction=Date.now()}},async syncContactsToNostr(){try{const e=x();console.log("Contacts sync to Nostr planned for future release",this.contacts.length,"contacts")}catch(e){console.error("Failed to sync contacts to Nostr:",e)}},async startAlwaysOnMode(){if(!E.isNativePlatform()){q("Always-on mode is only available on Android devices");return}try{const e=await m.startAlwaysOnMode();e.success?(this.alwaysOnActive=!0,w("Always-on mode started. Bluetooth mesh will stay active 24/7."),console.log("Always-on mode started:",e.message)):p("Failed to start always-on mode")}catch(e){console.error("Error starting always-on mode:",e),p(`Failed to start always-on mode: ${e.message}`)}},async stopAlwaysOnMode(){if(!E.isNativePlatform()){q("Always-on mode is only available on Android devices");return}try{const e=await m.stopAlwaysOnMode();e.success?(this.alwaysOnActive=!1,this.alwaysOnEnabled=!1,w("Always-on mode stopped"),console.log("Always-on mode stopped:",e.message)):p("Failed to stop always-on mode")}catch(e){console.error("Error stopping always-on mode:",e),p(`Failed to stop always-on mode: ${e.message}`)}},async checkAlwaysOnStatus(){if(!E.isNativePlatform()){this.alwaysOnActive=!1;return}try{const e=await m.isAlwaysOnActive();this.alwaysOnActive=e.isActive,console.log("Always-on status checked:",this.alwaysOnActive)}catch(e){console.error("Error checking always-on status:",e),this.alwaysOnActive=!1}},async toggleAlwaysOnMode(e){this.alwaysOnEnabled=e,e?await this.startAlwaysOnMode():await this.stopAlwaysOnMode()},async requestBatteryOptimizationExemption(){if(!E.isNativePlatform()){q("Battery optimization settings are only available on Android devices");return}try{const e=await m.requestBatteryOptimizationExemption();e.success?(w("Battery optimization dialog opened. Please allow Bitpoints to run in background."),console.log("Battery optimization exemption requested:",e.message)):p("Failed to open battery optimization settings")}catch(e){console.error("Error requesting battery optimization exemption:",e),p(`Failed to open battery settings: ${e.message}`)}}}});const Dn=se({name:"FavoriteRequestsDialog",setup(){const e=J(),t=_n(),n=x();return{pendingRequests:L(()=>e.pendingRequestsList),formatNpub:d=>d?`${d.substring(0,12)}...${d.substring(d.length-4)}`:"No Nostr key",formatTime:d=>{try{return en(new Date(d),{addSuffix:!0})}catch{return"Recently"}},acceptRequest:async d=>{try{e.acceptPendingRequest(d.peerNoisePublicKey),n.seedSignerPublicKey||await n.walletSeedGenerateKeyPair();const h=n.seedSignerPublicKey||n.pubkey;if(h){const P=h.startsWith("npub")?h:Te.npubEncode(h);await t.sendTextMessage(d.peerNoisePublicKey,`[FAVORITE_ACCEPTED]:${P}`),console.log(`\u{1F4E4} Sent favorite acceptance to ${d.peerNickname} with npub: ${P.substring(0,16)}...`)}w(`\u{1F495} You and ${d.peerNickname} are now mutual favorites!`)}catch(h){console.error("Failed to accept favorite request:",h)}},ignoreRequest:d=>{e.removePendingRequest(d.peerNoisePublicKey),w(`Ignored request from ${d.peerNickname}`)}}}}),ie=e=>(xe("data-v-7a5de990"),e=e(),Le(),e),Tn={class:"favorite-requests"},Fn={class:"q-pa-md"},Mn=ie(()=>_("h6",{class:"q-mt-none q-mb-md"},"Favorite Requests",-1)),En={key:0,class:"text-center q-py-xl"},Nn=ie(()=>_("div",{class:"q-mt-md text-grey-7"},"No pending requests",-1)),$n=ie(()=>_("div",{class:"text-caption text-grey-6 q-mt-sm"}," When someone favorites you, it will appear here ",-1)),Cn={class:"row items-center q-gutter-xs"};function qn(e,t,n,o,s,a){return g(),T("div",Tn,[_("div",Fn,[Mn,e.pendingRequests.length===0?(g(),T("div",En,[l(R,{name:"inbox",size:"4em",color:"grey-5"}),Nn,$n])):N("",!0),e.pendingRequests.length>0?(g(),I(it,{key:1,bordered:"",separator:"",class:"rounded-borders"},{default:c(()=>[(g(!0),T(Pe,null,Se(e.pendingRequests,i=>(g(),I(_e,{key:i.peerNoisePublicKey},{default:c(()=>[l(Y,{avatar:""},{default:c(()=>[l(Be,{color:"primary","text-color":"white"},{default:c(()=>[l(R,{name:"person_add"})]),_:1})]),_:1}),l(Y,null,{default:c(()=>[l($,null,{default:c(()=>[b(k(i.peerNickname),1)]),_:2},1024),l($,{caption:""},{default:c(()=>[b(k(e.formatNpub(i.peerNostrNpub)),1)]),_:2},1024),l($,{caption:"",class:"text-grey-6 q-mt-xs"},{default:c(()=>[b(k(e.formatTime(i.receivedAt)),1)]),_:2},1024)]),_:2},1024),l(Y,{side:""},{default:c(()=>[_("div",Cn,[l(V,{flat:"",dense:"",round:"",size:"sm",icon:"check",color:"positive",onClick:r=>e.acceptRequest(i)},{default:c(()=>[l(pe,null,{default:c(()=>[b("Accept")]),_:1})]),_:2},1032,["onClick"]),l(V,{flat:"",dense:"",round:"",size:"sm",icon:"close",color:"grey",onClick:r=>e.ignoreRequest(i)},{default:c(()=>[l(pe,null,{default:c(()=>[b("Ignore")]),_:1})]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})):N("",!0)])])}var so=ae(Dn,[["render",qn],["__scopeId","data-v-7a5de990"]]);const Q={NWCInfo:13194,NWCRequest:23194,NWCResponse:23195},ao=G("nwc",{state:()=>({nwcEnabled:y("cashu.nwc.enabled",!1),connections:y("cashu.nwc.connections",[]),seenCommandsUntil:y("cashu.nwc.seenCommandsUntil",0),supportedMethods:["pay_invoice","make_invoice","get_balance","get_info","list_transactions","lookup_invoice"],blocking:!1,ndk:new ne,subscriptions:[],showNWCDialog:!1,showNWCData:{connection:{},connectionString:""}}),getters:{},actions:{handleGetInfo:async function(e){return console.log("### get_info",e.method),{result_type:"get_info",result:{alias:"Cashu.me",color:"#FF0000",pubkey:this.connections[0].walletPublicKey,network:"mainnet",block_height:1,block_hash:"blockchain disrespectoor",methods:this.supportedMethods}}},handleGetBalance:async function(e){const t=B();return console.log("### get_balance",e.method),{result_type:"get_balance",result:{balance:t.totalUnitBalance*1e3}}},handlePayInvoice:async function(e){const t=e.params.invoice,n=e.params.amount;console.log("### pay_invoice",e.method),console.log("### invoice",t),console.log("### amountMsat",n);const o=A(),s=je(),a=B();try{await o.decodeRequest(t)}catch(r){return console.log("### error decoding invoice",r),{result_type:e.method,error:{code:"INTERNAL",message:"Invalid invoice"}}}if(o.payInvoiceData.meltQuote.response.amount==0||o.payInvoiceData.meltQuote.error)return q("NWC: Error requesting melt quote"),{result_type:e.method,error:{code:"INTERNAL",message:"Error requesting melt quote"}};const i=o.payInvoiceData.meltQuote.response.amount+o.payInvoiceData.meltQuote.response.fee_reserve;if(a.activeUnit!="sat")return q("NWC: Active unit must be sats"),{result_type:e.method,error:{code:"INTERNAL",message:"Your active must be sats"}};if(i>this.connections[0].allowanceLeft)return q("NWC: Allowance exceeded"),{result_type:e.method,error:{code:"QUOTA_EXCEEDED",message:"Your quota has exceeded"}};try{const r=await o.meltInvoiceData(),d=o.payInvoiceData.meltQuote.response.amount+o.payInvoiceData.meltQuote.response.fee_reserve-s.sumProofs(r.change);return this.connections[0].allowanceLeft-=d,{result_type:e.method,result:{}}}catch{return{result_type:e.method,error:{code:"INTERNAL",message:"Could not pay invoice"}}}},handleMakeInvoice:async function(e){const{amount:t,description:n,expiry:o}=e.params;console.log("### make_invoice"),console.log("### amount",t),console.log("### description",n),console.log("### expiry",o);const s=A(),a=await s.requestMint(t/1e3,s.wallet);return a?(s.mintOnPaid(a.quote,!1,!0),{result_type:e.method,result:{type:"incoming",invoice:a?.request,description:n,amount:t}}):{result_type:e.method,error:{code:"INTERNAL",message:"failed to request mint invoice"}}},handleListTransactions:async function(e){console.log("### list_transactions",e.method);const t=A(),n=e.params.from||0,o=e.params.until||Math.floor(Date.now()/1e3),s=e.params.limit||10,a=e.params.offset||0,i=e.params.unpaid||!1,r=e.params.type||void 0,P=t.invoiceHistory.filter(D=>{const f=new Date(D.date),F=Math.floor(f.getTime()/1e3);return!(n&&F<n||o&&F>o||r&&r=="incoming"&&D.amount<0||r&&r=="outgoing"&&D.amount>0||i&&D.status=="paid")}).slice(a,a+s).map(this.mapToNwcTransaction).sort((D,f)=>f.created_at-D.created_at);return{result_type:"list_transactions",result:{transactions:P}}},handleLookupInvoice:async function(e){let t=e.params.payment_hash;if(!t){const s=e.params.invoice;t=(s?ue.decode(s):null)?.sections.find(i=>i.name==="payment_hash")?.value}if(!t)return{result_type:e.method,error:{code:"OTHER",message:"invoice or payment_hash required"}};console.log("### lookup_invoice");const o=A().invoiceHistory;for(const s of o)if(ue.decode(e.params.invoice).sections.find(r=>r.name==="payment_hash")?.value===t)return{result_type:e.method,result:this.mapToNwcTransaction(s)};return{result_type:e.method,error:{code:"NOT_FOUND",message:"invoice not found"}}},mapToNwcTransaction(e){let t=e.amount>0?"incoming":"outgoing",n=Math.abs(e.amount)*1e3,o=Math.floor(new Date(e.date).getTime()/1e3),s=e.status=="paid"?Math.floor(new Date(e.date).getTime()/1e3):null;return{type:t,invoice:e.bolt11,description:e.memo,amount:n,fees_paid:0,created_at:o,settled_at:s}},replyNWC:async function(e,t,n){let o=new oe(t.ndk);o.kind=23195,console.log("### replying with",JSON.stringify(e)),o.content=await he.encrypt(n.walletPrivateKey,t.author.pubkey,JSON.stringify(e)),o.tags=[["p",t.author.pubkey],["e",t.id]],console.log("### replyEvent",o),console.log("### replying to",t.id),await o.publish()},parseNWCCommand:async function(e,t,n){let o=JSON.parse(e),s;if(console.log("### nwcCommand",o),o.method=="get_info")s=await this.handleGetInfo(o);else if(o.method=="get_balance")s=await this.handleGetBalance(o);else if(o.method=="pay_invoice"){this.blocking&&(s={result_type:o.method,error:{code:"INTERNAL",message:"Already processing a payment."}}),this.blocking=!0;try{s=await this.handlePayInvoice(o)}catch{return}finally{this.blocking=!1}}else o.method==="make_invoice"?s=await this.handleMakeInvoice(o):o.method=="list_transactions"?s=await this.handleListTransactions(o):o.method==="lookup_invoice"?s=await this.handleLookupInvoice(o):(console.log("### method not supported",o.method),s={result_type:o.method,error:{code:"NOT_IMPLEMENTED",message:"Method not supported"}});await this.replyNWC(s,t,n)},getConnectionString:function(e){const t=e.walletPublicKey,n=e.connectionSecret,o=x();return`nostr+walletconnect://${t}?relay=${o.relays.join("&relay=")}&secret=${n}`},generateNWCConnection:async function(){let e;if(this.connections.length)e=this.connections[0];else{const s=me(),a=fe(s),i=ge(s),r=me(),d=fe(r),h=ge(r);e={walletPublicKey:a,walletPrivateKey:i,connectionSecret:h,connectionPublicKey:d,allowanceLeft:1e3},this.connections=this.connections.concat(e)}const t=new ze(e.walletPrivateKey);this.unsubscribeNWC();const n=x();this.ndk=new ne({explicitRelayUrls:n.relays,signer:t}),this.ndk.connect();const o=new oe(this.ndk);o.kind=Q.NWCInfo,o.content=this.supportedMethods.join(" ");try{let s={kinds:[Q.NWCInfo],authors:[e.walletPublicKey]};(await this.ndk.fetchEvents(s)).size===0?(await o.publish(),console.log("### published nip47InfoEvent",o)):console.log("### nip47InfoEvent already published")}catch(s){console.log("### could not publish nip47InfoEvent",o),console.log("### error",s)}},listenToNWCCommands:async function(){await this.generateNWCConnection();const e=this.connections[0],n=Math.floor(Date.now()/1e3)-60;let o={kinds:[Q.NWCRequest],since:n,authors:[e.connectionPublicKey],"#p":[e.walletPublicKey]};const s=this.ndk.subscribe(o),a=x();console.log("### subscribing to NWC on relays: ",a.relays),this.subscriptions.push(s),s.on("eose",()=>console.log("All relays have reached the end of the event stream")),s.on("close",()=>console.log("Subscription closed")),s.on("event",async i=>{if(i.kind!=Q.NWCRequest)return;if(!this.nwcEnabled){console.log("### Received NWC command but NWC is disabled");return}if(i.created_at<=this.seenCommandsUntil)return;this.seenCommandsUntil=i.created_at,console.log("### NWC request!"),console.log("### event",i);const r=await he.decrypt(e.connectionSecret,e.walletPublicKey,i.content);await this.parseNWCCommand(r,i,e)})},unsubscribeNWC:function(){console.log("### unsubscribing from NWC");for(let e of this.subscriptions)e.stop();this.subscriptions=[]}}}),An=27235,io=G("npcV2",{state:()=>({npcV2Enabled:y("cashu.npc.v2.enabled",!1),npcV2ClaimAutomatically:y("cashu.npc.v2.claimAutomatically",!0),npcV2LastCheck:y("cashu.npc.v2.lastCheck",null),npcV2Address:y("cashu.npc.v2.address",""),npcV2Mint:y("cashu.npc.v2.mint",null),npcV2Domain:"",npcV2BaseURL:y("cashu.npc.v2.baseURL","https://npubx.cash"),npcV2Loading:!1}),getters:{},actions:{generateNPCV2Connection:async function(){if(!this.npcV2Enabled)return;const e=x(),t=B();if(!e.pubkey)return;const n=e.pubkey;this.npcV2Domain=new URL(this.npcV2BaseURL).hostname,this.npcV2Address=Te.npubEncode(n)+"@"+this.npcV2Domain,this.npcV2Loading=!0;try{const o=this.npcV2Address,s=await this.getV2Info();if(s.name){const a=s.name+"@"+this.npcV2Domain;o!==a&&w(`Logged in as ${s.name}`),this.npcV2Address=a}t.mints.map(a=>a.url).includes(s.mintUrl)?this.npcV2Mint=s.mintUrl:t.activeMintUrl?await this.changeMintUrl(t.activeMintUrl):(await t.addMint({url:s.mintUrl}),this.npcV2Mint=s.mintUrl)}catch(o){o instanceof Error&&Qe(o),console.log(o)}finally{this.npcV2Loading=!1}},getV2Info:async function(){try{const t=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/info`)).json();if(t.error)throw p(t.message),new Error(t.message);return t.data.user}catch(e){return console.error(e),{mintUrl:"",name:"",pubkey:"",lockQuote:!1}}},changeMintUrl:async function(e){if(!B().mints.find(n=>n.url===e)){p(`Please make sure ${e} is added to your wallet first!`,"Could not update npubx.cash mint");return}try{const o=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/mint`,{headers:{"Content-Type":"application/json"},method:"PATCH",body:JSON.stringify({mint_url:e})})).json();if(o.error)throw new Error(o.message);this.npcV2Mint=o.data.user.mintUrl}catch(n){console.log(n),n instanceof Error?p(n.message):p("Something went wrong!")}},getLatestQuotes:async function(){if(!this.npcV2Enabled)return;const e=A(),t=this.npcV2LastCheck?`?since=${this.npcV2LastCheck}`:"",n=`${this.npcV2BaseURL}/api/v2/wallet/quotes`;try{const s=await(await this.sendAuthedRequest(n+t,void 0,n)).json();if(s.error)return;let a;s.data.quotes.forEach(async i=>{e.invoiceHistory.find(r=>r.quote===i.quoteId)||((!a||a<i.createdAt)&&(a=i.createdAt),await e.invoiceHistory.push({label:"Zap",mint:i.mintUrl,memo:"",bolt11:i.request,amount:i.amount,quote:i.quoteId,date:Ye.formatDate(new Date(i.createdAt*1e3),"YYYY-MM-DD HH:mm:ss"),status:"pending",unit:"sat",mintQuote:{request:i.request,quote:i.quoteId,state:Xe.PAID,expiry:i.expiresAt,amount:i.amount,unit:"sat"}}),this.npcV2ClaimAutomatically&&await e.mintOnPaid(i.quoteId))}),a&&(this.npcV2LastCheck=a)}catch(o){console.error(o);return}},getUsernameQuote:async function(e){const t=await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/username`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})}),n=await t.json();if(n.error){if(t.status===402){const o=t.headers.get("X-Cashu");if(!o)throw new Error("Unexpected reply without payment request");return{username:e,creq:o}}throw new Error(n.message)}throw new Error("Unexpected reply without payment request")},setUsername:async function(e,t){try{const o=await(await this.sendAuthedRequest(`${this.npcV2BaseURL}/api/v2/user/username`,{method:"POST",headers:{"Content-Type":"application/json","X-Cashu":t},body:JSON.stringify({username:e})})).json();if(o.error)throw new Error(o.message);this.npcV2Address=`${o.data.user.name}@${this.npcV2Domain}`}catch(n){console.log(n),n instanceof Error&&p(n.message)}},sendAuthedRequest:async function(e,t,n){const o=await this.generateNip98Event(n||e,t?.method||"GET");return fetch(e,{...t,headers:{...t?.headers,authorization:`Nostr ${o}`}})},generateNip98Event:async function(e,t){const n=x();await n.initSignerIfNotSet();const o=new oe(new ne);o.kind=An,o.content="",o.tags=[["u",e],["method",t]],await o.sign(n.signer);const s=JSON.stringify(o.rawEvent());return btoa(s)}}});export{m as B,to as C,so as F,no as P,Gn as Q,rt as a,Jn as b,Zn as c,tn as d,oo as e,en as f,J as g,ao as h,io as i,eo as m,_n as u};
